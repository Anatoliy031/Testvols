<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>АО «Россети Кубань» — ВОЛС: аналитика и отчётность</title>

  <!-- Шрифты -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ====== Design System Tokens ====== */
    :root {
      /* Brand Colors */
      --rs-blue: #0033A0;
      --rs-blue-600: #0A47C6;
      --rs-blue-700: #002570;
      --rs-accent: #00AEEF;
      --rs-accent-light: #40C4FF;
      
      /* Backgrounds */
      --bg-main: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
      --bg-card: #FFFFFF;
      --bg-hover: #FAFBFC;
      --bg-glass: rgba(255, 255, 255, 0.95);
      
      /* Borders */
      --border-light: #E2E8F0;
      --border-medium: #CBD5E1;
      
      /* Text */
      --text-primary: #0F172A;
      --text-secondary: #475569;
      --text-muted: #64748B;
      --text-white: #FFFFFF;
      
      /* Status Colors */
      --status-success: #059669;
      --status-error: #DC2626;
      --status-warning: #D97706;
      --status-info: #0284C7;
      
      /* Effects */
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.08);
      --shadow-lg: 0 10px 20px rgba(0,0,0,0.15), 0 3px 6px rgba(0,0,0,0.10);
      --shadow-xl: 0 15px 25px rgba(0,0,0,0.15), 0 5px 10px rgba(0,0,0,0.05);
      
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* ====== Base Styles ====== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-main);
      color: var(--text-primary);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }

    /* ====== Header ====== */
    header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: linear-gradient(135deg, var(--rs-blue) 0%, var(--rs-blue-600) 100%);
      padding: 24px 0;
      box-shadow: var(--shadow-lg);
    }

    .header-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo-mark {
      width: 48px;
      height: 48px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 0 0 4px rgba(255,255,255,0.2);
    }

    .logo-mark::before {
      content: '';
      width: 20px;
      height: 20px;
      background: var(--rs-blue);
      border-radius: 50%;
    }

    .brand-text {
      color: white;
    }

    .brand-title {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: -0.5px;
    }

    .brand-subtitle {
      font-size: 14px;
      opacity: 0.9;
    }

    /* ====== Container & Grid ====== */
    .container {
      max-width: 1400px;
      margin: 32px auto;
      padding: 0 24px;
    }

    .grid {
      display: grid;
      gap: 24px;
    }

    .cols-2 { grid-template-columns: repeat(2, 1fr); }
    .cols-3 { grid-template-columns: repeat(3, 1fr); }
    
    @media (max-width: 1200px) {
      .cols-3 { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 768px) {
      .cols-2, .cols-3 { grid-template-columns: 1fr; }
    }

    /* ====== Card Component ====== */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 28px;
      box-shadow: var(--shadow-md);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--rs-accent), var(--rs-blue-600));
      transform: scaleX(0);
      transition: transform 0.3s;
    }

    .card:hover::before {
      transform: scaleX(1);
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-badge {
      display: inline-flex;
      padding: 4px 12px;
      background: linear-gradient(135deg, var(--rs-accent), var(--rs-blue-600));
      color: white;
      font-size: 11px;
      font-weight: 700;
      border-radius: 999px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ====== Input Components ====== */
    .input-group {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin: 20px 0;
    }

    .file-wrapper {
      flex: 1;
      min-width: 250px;
      position: relative;
      background: var(--bg-hover);
      border: 2px dashed var(--border-light);
      border-radius: var(--radius-md);
      padding: 16px;
      cursor: pointer;
      transition: var(--transition);
    }

    .file-wrapper:hover {
      border-color: var(--rs-accent);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .file-wrapper.has-file {
      border-style: solid;
      border-color: var(--status-success);
      background: rgba(5, 150, 105, 0.05);
    }

    input[type="file"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .file-label {
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    .file-name {
      font-size: 13px;
      color: var(--text-muted);
    }

    /* ====== Buttons ====== */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 28px;
      border-radius: var(--radius-md);
      font-weight: 600;
      font-size: 15px;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--rs-blue), var(--rs-blue-600));
      color: white;
      box-shadow: var(--shadow-md);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: white;
      color: var(--rs-blue);
      border: 2px solid var(--rs-blue);
    }

    .btn-secondary:hover {
      background: var(--rs-blue);
      color: white;
    }

    .btn-ghost {
      background: transparent;
      border: 2px solid var(--border-light);
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      background: var(--bg-hover);
      border-color: var(--border-medium);
    }

    .export-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    @media (max-width: 768px) {
      .export-grid { grid-template-columns: 1fr; }
    }

    /* ====== Status Messages ====== */
    .status-msg {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      font-size: 14px;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .status-msg.show { display: flex; }

    .status-msg.loading {
      background: rgba(2, 132, 199, 0.1);
      color: var(--status-info);
      border: 1px solid rgba(2, 132, 199, 0.2);
    }

    .status-msg.success {
      background: rgba(5, 150, 105, 0.1);
      color: var(--status-success);
      border: 1px solid rgba(5, 150, 105, 0.2);
    }

    .status-msg.error {
      background: rgba(220, 38, 38, 0.1);
      color: var(--status-error);
      border: 1px solid rgba(220, 38, 38, 0.2);
    }

    /* ====== KPI Cards ====== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
    }

    @media (max-width: 1200px) {
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 640px) {
      .kpi-grid { grid-template-columns: 1fr; }
    }

    .kpi {
      background: linear-gradient(135deg, white, var(--bg-hover));
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      padding: 24px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .kpi::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, var(--rs-accent), transparent);
      opacity: 0.03;
    }

    .kpi:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-lg);
      border-color: var(--rs-accent);
    }

    .kpi-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .kpi-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1;
      margin-bottom: 8px;
    }

    .kpi-delta {
      font-size: 14px;
      font-weight: 600;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      display: inline-block;
    }

    .up {
      color: var(--status-success);
      background: rgba(5, 150, 105, 0.1);
    }

    .down {
      color: var(--status-error);
      background: rgba(220, 38, 38, 0.1);
    }

    .muted {
      color: var(--text-muted);
      background: var(--bg-hover);
    }

    /* ====== Tables ====== */
    .table-wrap {
      max-height: 500px;
      overflow: auto;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      background: white;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: 14px;
    }

    thead th {
      position: sticky;
      top: 0;
      background: linear-gradient(135deg, var(--rs-blue), var(--rs-blue-600));
      color: white;
      padding: 14px 16px;
      text-align: left;
      font-weight: 600;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      z-index: 10;
    }

    thead th:last-child { text-align: right; }

    tbody td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-light);
      font-variant-numeric: tabular-nums;
    }

    tbody td:last-child { text-align: right; }

    tbody tr:nth-child(even) {
      background: rgba(241, 245, 249, 0.5);
    }

    tbody tr:hover {
      background: var(--bg-hover);
    }

    tfoot td {
      background: var(--bg-hover);
      font-weight: 700;
      padding: 14px 16px;
      border-top: 2px solid var(--border-medium);
    }

    /* ====== Charts ====== */
    .chart-box {
      height: 420px;
      padding: 20px;
      background: var(--bg-hover);
      border-radius: var(--radius-md);
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* ====== Status Matrix ====== */
    .status-matrix-wrap {
      overflow-x: auto;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
    }

    .status-matrix {
      min-width: 800px;
    }

    /* ====== Plan-Fact Section ====== */
    .planfact-section {
      background: linear-gradient(135deg, white, var(--bg-hover));
      border: 2px solid var(--rs-blue);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 24px;
    }

    .planfact-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--rs-blue);
      margin-bottom: 20px;
      text-align: center;
    }

    #mainPlanFactInner table {
      text-align: center !important;
    }

    /* ====== Print Areas ====== */
    #presentationPrint, #summaryPrint {
      display: none;
      background: white;
      padding: 40px;
    }

    .print-header {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 3px solid var(--border-light);
    }

    .logoTitle {
      font-size: 28px;
      font-weight: 800;
      color: var(--rs-blue);
      margin-bottom: 8px;
    }

    /* ====== Compact Mode ====== */
    .compact table { font-size: 12px; }
    .compact .card { padding: 16px; }
    .compact .chart-box { height: 320px; }
    .compact .kpi-value { font-size: 24px; }

    /* ====== Utilities ====== */
    .note {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    .hr {
      height: 1px;
      background: var(--border-light);
      margin: 20px 0;
    }

    /* ====== Animations ====== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .animate-in {
      animation: fadeIn 0.3s ease-out;
    }

    /* ====== Print Styles ====== */
    @media print {
      body { background: white; }
      header { display: none; }
      .btn { display: none; }
      .table-wrap { max-height: none; overflow: visible; }
      .card { box-shadow: none; border: 1px solid var(--border-light); }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="header-container">
      <div class="brand">
        <div class="logo-mark"></div>
        <div class="brand-text">
          <div class="brand-title">АО «Россети Кубань»</div>
          <div class="brand-subtitle">ВОЛС: аналитика и отчётность</div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Controls -->
  <div class="container">
    <div class="grid cols-2">
      <!-- File Upload -->
      <div class="card animate-in">
        <h2 class="card-title">📊 Загрузка отчётов (PDF)</h2>
        <div class="input-group">
          <label class="file-wrapper" id="prevWrapper">
            <div class="file-label">Предыдущая неделя</div>
            <div class="file-name" id="prevFileName">PDF не выбран</div>
            <input id="filePrev" type="file" accept="application/pdf">
          </label>
          
          <label class="file-wrapper" id="currWrapper">
            <div class="file-label">Текущая неделя</div>
            <div class="file-name" id="currFileName">PDF не выбран</div>
            <input id="fileCurr" type="file" accept="application/pdf">
          </label>
        </div>
        
        <div class="input-group">
          <button id="btnParse" class="btn btn-primary" disabled>Проанализировать</button>
          <button id="btnCompact" class="btn btn-ghost">Компактный режим</button>
        </div>
        
        <div class="note" id="dates">Даты отчётов: —</div>
        <div class="note">«Выявлено за неделю» = «В работе всего, шт.» (текущая − предыдущая).</div>
        <div class="status-msg loading" id="loadingMsg">
          <strong>Обработка PDF...</strong>
        </div>
        <div class="status-msg error" id="errorMsg"></div>
      </div>

      <!-- Export Controls -->
      <div class="card animate-in">
        <h2 class="card-title">💾 Выгрузки (формат Россети)</h2>
        <div class="export-grid">
          <button class="btn btn-secondary" id="exportPresPDF">Скачать презентацию (PDF)</button>
          <button class="btn btn-secondary" id="exportPresHTML">Скачать презентацию (HTML)</button>
          <button class="btn btn-secondary" id="exportWordHTML">Скачать отчёт (Word HTML)</button>
          <button class="btn btn-secondary" id="exportBriefPDF">Скачать полный табличный PDF</button>
        </div>
        <div class="status-msg success" id="exportStatus"></div>
      </div>
    </div>
  </div>

  <!-- Plan-Fact Section -->
  <div class="container">
    <div class="planfact-section">
      <h2 class="planfact-title">План-Факт выполнения показателей</h2>
      <div id="mainPlanFactInner"></div>
    </div>
  </div>

  <!-- KPI Dashboard -->
  <div class="container">
    <div class="card">
      <h2 class="card-title">
        Ключевые показатели
        <span class="card-badge">Обновлено</span>
      </h2>
      <div id="kpis" class="kpi-grid"></div>
    </div>
  </div>

  <!-- Page 2 Charts -->
  <div class="container">
    <div class="grid cols-2">
      <div class="card">
        <h2 class="card-title">Стр. 2 — Всего опор по филиалам</h2>
        <div class="chart-box"><canvas id="chartBranches"></canvas></div>
      </div>
      <div class="card">
        <h2 class="card-title">Таблица — Δ «Всего опор, шт.»</h2>
        <div class="table-wrap">
          <table id="tblBranches">
            <thead><tr><th>Филиал</th><th>Пред.</th><th>Тек.</th><th>Δ</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td>Итого</td><td id="sumPrev">0</td><td id="sumCurr">0</td><td id="sumDelta">0</td></tr></tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Page 3 Charts -->
  <div class="container">
    <div class="grid cols-2">
      <div class="card">
        <h2 class="card-title">Стр. 3 — Приказ №425</h2>
        <div class="chart-box"><canvas id="chartBranchesS3"></canvas></div>
      </div>
      <div class="card">
        <h2 class="card-title">Таблица — Приказ №425</h2>
        <div class="table-wrap">
          <table id="tblBranchesS3">
            <thead><tr><th>Филиал</th><th>Пред.</th><th>Тек.</th><th>Δ</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td>Итого</td><td id="sumPrevS3">0</td><td id="sumCurrS3">0</td><td id="sumDeltaS3">0</td></tr></tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Page 4 Charts -->
  <div class="container">
    <div class="grid cols-2">
      <div class="card">
        <h2 class="card-title">Стр. 4 — ПАО «Ростелеком»</h2>
        <div class="chart-box"><canvas id="chartBranchesS4"></canvas></div>
      </div>
      <div class="card">
        <h2 class="card-title">Таблица — ПАО «Ростелеком»</h2>
        <div class="table-wrap">
          <table id="tblBranchesS4">
            <thead><tr><th>Филиал</th><th>Пред.</th><th>Тек.</th><th>Δ</th></tr></thead>
            <tbody></tbody>
            <tfoot><tr><td>Итого</td><td id="sumPrevS4">0</td><td id="sumCurrS4">0</td><td id="sumDeltaS4">0</td></tr></tfoot>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- RTK Delta Chart -->
  <div class="container">
    <div class="card">
      <h2 class="card-title">ПАО «Ростелеком» — Δ по филиалам</h2>
      <div class="chart-box"><canvas id="chartRTKDelta"></canvas></div>
    </div>
  </div>

  <!-- Stages Tables -->
  <div class="container">
    <div class="grid cols-3">
      <div class="card">
        <h2 class="card-title">Стр. 2 — Стадии</h2>
        <div class="table-wrap">
          <table id="tblStagesS2">
            <thead><tr><th>Стадия</th><th>Пред.</th><th>Тек.</th><th>Δ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <h2 class="card-title">Стр. 4 — Стадии (РТК)</h2>
        <div class="table-wrap">
          <table id="tblStagesS4">
            <thead><tr><th>Стадия</th><th>Пред.</th><th>Тек.</th><th>Δ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="card">
        <h2 class="card-title">📈 Динамика</h2>
        <div style="padding: 20px; text-align: center; color: var(--text-muted);">
          <p>Загрузите отчёты для отображения динамики</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Print Areas -->
  <div id="presentationPrint">
    <div class="logoTitle">АО «Россети Кубань» — Динамика ВОЛС</div>
    <div id="presPlanFactTop"><div id="presPlanFactInner"></div></div>
    <div id="presDates" class="note"></div>
    <div id="presKpis"></div>
    <div class="hr"></div>
    <div id="presTable"></div>
    <div class="hr"></div>
    <div id="presTableS3"></div>
    <div class="hr"></div>
    <div id="presTableS4"></div>
    <div class="hr"></div>
    <div id="presStages"></div>
  </div>

  <div id="summaryPrint">
    <div class="logoTitle">Полный табличный отчёт</div>
    <div id="briefPlanFactTop"><div id="briefPlanFactInner"></div></div>
    <div id="briefDates" class="note"></div>
    <div id="briefBlocks"></div>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
  /* ==================== Constants & Utils ==================== */
  const BRANCHES = [
    "Сочинские ЭС","Тимашевские ЭС","Тихорецкие ЭС","Усть-Лабинские ЭС","Юго-Западные ЭС",
    "Адыгейские ЭС","Армавирские ЭС","Краснодарские ЭС","Лабинские ЭС","Ленинградские ЭС","Славянские ЭС"
  ];
  const BRANCH_PATTERNS = [
    {name:"Сочинские ЭС", re:/Сочинские\s+ЭС/i},
    {name:"Тимашевские ЭС", re:/Тимашевские\s+ЭС/i},
    {name:"Тихорецкие ЭС", re:/Тихорецкие\s+ЭС/i},
    {name:"Усть-Лабинские ЭС", re:/Усть[\s\u00A0\u202F\-–—-]*Лабинские\s+ЭС/i},
    {name:"Юго-Западные ЭС", re:/Юго[\s\u00A0\u202F\-–—-]*Западные\s+ЭС/i},
    {name:"Адыгейские ЭС", re:/Адыгейские\s+ЭС/i},
    {name:"Армавирские ЭС", re:/Армавирские\s+ЭС/i},
    {name:"Краснодарские ЭС", re:/Краснодарские\s+ЭС/i},
    {name:"Лабинские ЭС", re:/Лабинские\s+ЭС/i},
    {name:"Ленинградские ЭС", re:/Ленинградские\s+ЭС/i},
    {name:"Славянские ЭС", re:/Славянские\s+ЭС/i},
  ];

  const STATUS_PATTERNS = [
    {key:"work", title:"В работе у филиала", re:/В\s*работе\s*у\s*филиала/i},
    {key:"dismantled", title:"Демонтировано", re:/Демонтировано/i},
    {key:"rc_digit", title:"Договор на оформлении Россети Цифра", re:/Договор\s*на\s*оформлении\s*Россети\s*Цифра/i},
    {key:"op_sign", title:"Договор на подписании у оператора", re:/Договор\s*на\s*подписании\s*у\s*оператора/i},
    {key:"filial_appr",title:"Договор на согласовании в филиале", re:/Договор\s*на\s*согласовании\s*в\s*филиале/i},
    {key:"incl_next", title:"Будет включено в следующее доп. соглашение после подписания",
      re:/Будет\s*включено(?:[\s\S]{0,80})в(?:\s*следующее)?(?:[\s\S]{0,80})доп\.?\s*соглашение(?:[\s\S]{0,80}после\s*подписания)?/i
    },
  ];
  const STATUS_KEYS = STATUS_PATTERNS.map(s => s.key);
  const STAGE_TITLE = k => (STATUS_PATTERNS.find(s => s.key===k)||{}).title||k;

  const SHORT_STAGE_TITLES = {
    "work": "В работе",
    "dismantled": "Демонт.",
    "rc_digit": "Оформл. РЦ",
    "op_sign": "Подпись опер.",
    "filial_appr": "Согл. филиал",
    "incl_next": "В след. доп.согл."
  };
  const SHORT_STAGE_TITLE = k => SHORT_STAGE_TITLES[k] || STAGE_TITLE(k);

  const numberize = s => {
    const t = String(s||"").replace(/\u00A0|\u202F/g," ").replace(/[^\d\- ,.%]/g,"").trim();
    const n = t.replace(/[^\d\-.,]/g,"").replace(/\s+/g,"");
    if(!n) return 0;
    const val = Number(n.replace(",", "."));
    return isNaN(val) ? 0 : val;
  };
  const fmt = n => (typeof n === "number" ? n : Number(n||0)).toLocaleString("ru-RU");
  const normalize = txt => String(txt||"")
      .replace(/\u00A0|\u202F/g," ")
      .replace(/\u00AD/g,"")
      .replace(/[\u2010-\u2015\u2212\uFE58\uFE63\uFF0D]/g,"-")
      .replace(/[ \t]+/g," ")
      .trim();

  /* ==================== PDF Reading ==================== */
  async function pdfToPages(file){
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const pages = [];
    for(let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      let pageText = "", lastY = null;
      content.items.forEach(item => {
        const y = item.transform[5];
        if(lastY !== null && Math.abs(y - lastY) > 5) pageText += "\n";
        pageText += item.str;
        lastY = y;
      });
      pages.push(normalize(pageText));
    }
    return pages;
  }

  /* ==================== Parsing ==================== */
  function extractDateFromPages(pages){
    for(const pg of pages){
      const m = pg.match(/по состоянию на\s+(\d{2}\.\d{2}\.\d{4})/i);
      if(m) return m[1];
    }
    return "—";
  }

  function parseTotalsFromPage(page1){
    const find = (re) => {
      const m = page1.match(re);
      return m ? numberize(m[1]) : 0;
    };
    return {
      found_year: find(/выявлено[^0-9]*?(\d[\d\s]+)\s*шт/i),
      legalized: find(/Узаконено[^0-9]*?(\d[\d\s]+)/i),
      dismantled_ytd: find(/За\s*20\d{2}\s*год\s*демонтировано[^0-9]*?(\d[\d\s]+)/i),
      in_work_total: find(/В\s*работе[^0-9]*?всего[^0-9]*?(\d[\d\s]+)\s*шт/i),
      rtk_in_work: find(/в\s*том\s*числе\s*ПАО\s*«?Ростелеком»?[^0-9]*?(\d[\d\s]+)/i),
    };
  }

  function parseBranchTable(pageText){
    const text = normalize(pageText);
    const lines = text.split("\n").filter(Boolean);

    const idx = [];
    for(let i=0;i<lines.length;i++){
      const line = lines[i];
      for(const bp of BRANCH_PATTERNS){
        if(bp.re.test(line)){ idx.push({i, name: bp.name}); break; }
      }
    }
    idx.push({i: lines.length, name:null});

    const branches = new Map();
    for(let k=0;k<idx.length-1;k++){
      const start = idx[k].i, end = idx[k+1].i, branchName = idx[k].name;
      if(!branchName) continue;
      const headLine = lines[start] || "";
      const segText = lines.slice(start+1, end).join(" ");

      let total = 0;
      const headNums = headLine.match(/\d[\d\s]*/g);
      if(headNums && headNums.length) total = numberize(headNums[headNums.length-1]);
      if(total===0 && lines[start+1]){
        const n2 = (lines[start+1]||"").match(/\d[\d\s]*/g);
        if(n2 && n2.length) total = numberize(n2[n2.length-1]);
      }

      const data = { total, statuses:{} };

      function numAfter(re, hay){
        const rx = new RegExp(re.source + "[^\\d]{0,200}(\\d[\\d\\s]*)", re.flags);
        const m = hay.match(rx);
        return m ? numberize(m[1]) : null;
      }

      for(const sp of STATUS_PATTERNS){
        let v = numAfter(sp.re, segText);
        if(v === null){
          for(let j=start+1;j<end;j++){
            const l0 = lines[j]||"", l1 = lines[j+1]||"";
            if(sp.re.test(l0) || sp.re.test(l1)){
              let cap = (l0.match(/(\d[\d\s]*)/g)||[]).pop();
              if(!cap) cap = (l1.match(/(\d[\d\s]*)/g)||[]).pop();
              if(cap){ v = numberize(cap); break; }
            }
          }
        }
        if(v !== null) data.statuses[sp.key] = v;
      }
      branches.set(branchName, data);
    }

    for(const b of BRANCHES){
      if(!branches.has(b)) branches.set(b, { total:0, statuses:{} });
    }

    const stages = {};
    for(const [_, obj] of branches){
      for(const [k,v] of Object.entries(obj.statuses)){
        stages[k] = (stages[k]||0) + (v||0);
      }
    }

    const overall = [...branches.values()].reduce((s,r)=>s+(r.total||0),0);
    return { branches, overall, stages };
  }

  function parseReportByPages(pages){
    return {
      date: extractDateFromPages(pages),
      p1: { totals: parseTotalsFromPage(pages[0] || "") },
      p2: parseBranchTable(pages[1] || ""),
      p3: parseBranchTable(pages[2] || ""),
      p4: parseBranchTable(pages[3] || ""),
    };
  }

  /* ==================== Dynamics ==================== */
  function computeDynamics(curr, prev){
    const dyn = {
      in_work_total: (curr.p1.totals.in_work_total - prev.p1.totals.in_work_total) || 0,
      rtk_in_work: (curr.p1.totals.rtk_in_work - prev.p1.totals.rtk_in_work) || 0,
      legalized: (curr.p1.totals.legalized - prev.p1.totals.legalized) || 0,
      dismantled_ytd:(curr.p1.totals.dismantled_ytd- prev.p1.totals.dismantled_ytd)|| 0,
    };
    dyn.found_week = dyn.in_work_total;

    const makeRows = (cPage, pPage) => BRANCHES.map(b=>{
      const c = cPage.branches.get(b)?.total || 0;
      const p = pPage.branches.get(b)?.total || 0;
      return {b, p, c, d: (c - p)};
    });

    const branchRows = makeRows(curr.p2, prev.p2);
    const branchRowsS3 = makeRows(curr.p3, prev.p3);
    const branchRowsS4 = makeRows(curr.p4, prev.p4);

    const allKeys = Array.from(new Set([
      ...Object.keys(prev.p2.stages||{}), ...Object.keys(curr.p2.stages||{}),
      ...Object.keys(prev.p3.stages||{}), ...Object.keys(curr.p3.stages||{}),
      ...Object.keys(prev.p4.stages||{}), ...Object.keys(curr.p4.stages||{}),
      ...STATUS_KEYS
    ]));

    const diffStages = (cur, prv) => allKeys.map(k=>({
      stage: STAGE_TITLE(k), short: SHORT_STAGE_TITLE(k), key: k,
      p: prv[k] || 0, c: cur[k] || 0, d: (cur[k]||0) - (prv[k]||0)
    }));

    const stagesS2 = diffStages(curr.p2.stages||{}, prev.p2.stages||{});
    const stagesS4 = diffStages(curr.p4.stages||{}, prev.p4.stages||{});

    function perBranchStages(cPage, pPage){
      return BRANCHES.map(b=>{
        const cst = cPage.branches.get(b)?.statuses || {};
        const pst = pPage.branches.get(b)?.statuses || {};
        const by = {};
        STATUS_KEYS.forEach(k=>{
          const p = pst[k]||0, c = cst[k]||0;
          by[k] = {p,c,d:c-p};
        });
        return {b, by};
      });
    }
    const s2BranchStages = perBranchStages(curr.p2, prev.p2);

    return {
      ...dyn,
      branchRows,
      branchRowsS3,
      branchRowsS4,
      stagesS2,
      stagesS4,
      s2BranchStages,
      rtkRows: branchRowsS4
    };
  }

  /* ==================== Render Functions ==================== */
  let chartBranches, chartBranchesS3, chartBranchesS4, chartRTKDelta;

  function renderKpis(curr, prev, dyn){
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

    const items = [
      {title:"В работе всего, шт.", curr:curr.p1.totals.in_work_total, delta:dyn.in_work_total},
      {title:"Выявлено за неделю, шт.", curr:dyn.found_week, delta:dyn.found_week},
      {title:"Закрыто за неделю, шт.", curr:eff, delta:eff},
      {title:"ПАО «Ростелеком», шт. (%)", curr:`${fmt(curr.p1.totals.rtk_in_work)} (${rtkShare.toFixed(1)}%)`, delta:dyn.rtk_in_work},
    ];

    document.getElementById("kpis").innerHTML = items.map(it=>{
      const d = typeof it.delta==="number"?it.delta:0;
      const cls=d>0?"up":(d<0?"down":"muted");
      const sign=d>0?"+":"";
      return `<div class="kpi">
        <div class="kpi-title">${it.title}</div>
        <div class="kpi-value">${typeof it.curr==="number"?fmt(it.curr):it.curr}</div>
        <div class="kpi-delta ${cls}">${sign}${fmt(d)}</div>
      </div>`;
    }).join("");
  }

  function renderBranchesTable(rows, tbodySel, sumPrevId, sumCurrId, sumDeltaId){
    const tbody = document.querySelector(tbodySel);
    tbody.innerHTML = "";
    let sP=0,sC=0,sD=0;
    
    // Sort alphabetically А-Я
    const collator = new Intl.Collator("ru", {sensitivity:"base"});
    const sorted = [...rows].sort((a,b) => collator.compare(a.b, b.b));
    
    for(const r0 of sorted){
      const p = Number(r0.p)||0, c = Number(r0.c)||0;
      const d = c - p;
      const cls = d>0?"up":(d<0?"down":"muted");
      sP+=p; sC+=c; sD+=d;
      tbody.insertAdjacentHTML("beforeend",
        `<tr><td>${r0.b}</td><td>${fmt(p)}</td><td>${fmt(c)}</td><td><span class="kpi-delta ${cls}">${d>0?"+":""}${fmt(d)}</span></td></tr>`);
    }
    document.getElementById(sumPrevId).textContent = fmt(sP);
    document.getElementById(sumCurrId).textContent = fmt(sC);
    document.getElementById(sumDeltaId).innerHTML = `<span class="kpi-delta ${sD>0?"up":(sD<0?"down":"muted")}">${(sD>0?"+":"")+fmt(sD)}</span>`;
  }

  function chartOpts(){
    return {
      responsive:true,
      maintainAspectRatio:false,
      plugins:{
        legend:{
          position:"top",
          labels:{
            boxWidth:16,
            usePointStyle:true,
            font:{family:"Inter",size:12,weight:"600"},
            color:"#475569"
          }
        }
      },
      scales:{
        y:{
          beginAtZero:true,
          ticks:{
            precision:0,
            font:{family:"Inter",size:11},
            color:"#64748B"
          },
          grid:{color:"rgba(0,0,0,0.05)"}
        },
        x:{
          ticks:{
            font:{family:"Inter",size:11},
            color:"#64748B"
          },
          grid:{display:false}
        }
      }
    };
  }

  function renderCharts(curr, prev, dyn){
    // Sort branches alphabetically
    const collator = new Intl.Collator("ru", {sensitivity:"base"});
    const sortedS2 = [...dyn.branchRows].sort((a,b) => collator.compare(a.b, b.b));
    const sortedS3 = [...(dyn.branchRowsS3 || [])].sort((a,b) => collator.compare(a.b, b.b));
    const sortedS4 = [...(dyn.branchRowsS4 || [])].sort((a,b) => collator.compare(a.b, b.b));
    
    const listAll = rows => rows.map(r=>{
      const p=Number(r.p)||0,c=Number(r.c)||0,d=c-p;
      return `• ${r.b}: ${fmt(p)} → <b>${fmt(c)}</b> (${d>0?'+':''}${fmt(d)})`;
    }).join("<br/>");

    blocks.innerHTML = `<h3 style="color:#0033A0;margin-top:24px">Стр. 1 — Общая (нарастающим)</h3>
      <div>• В работе всего: <b>${fmt(curr.p1.totals.in_work_total)}</b> (${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)})</div>
      <div>• Выявлено за неделю: <b>${fmt(dyn.found_week)}</b></div>
      <div>• Закрыто за неделю: <b>${fmt(eff)}</b></div>
      <div>• ПАО «Ростелеком» в работе: <b>${fmt(curr.p1.totals.rtk_in_work)}</b> (${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})</div>
      <hr style="border:none;border-top:1px solid #E2E8F0;margin:20px 0"/>
      <h3 style="color:#0033A0">Динамика по филиалам (всего)</h3>
      <div>${listAll(sortedS2)}</div>
      <div style="margin-top:12px;font-weight:700">Итого: Пред. ${document.getElementById("sumPrev").textContent}; Тек. ${document.getElementById("sumCurr").textContent}; Δ ${document.getElementById("sumDelta").textContent.replace(/<[^>]*>/g,'')}</div>
      <hr style="border:none;border-top:1px solid #E2E8F0;margin:20px 0"/>
      <h3 style="color:#0033A0">В том числе: динамика по Приказу №425</h3>
      <div>${listAll(sortedS3)}</div>
      <div style="margin-top:12px;font-weight:700">Итого: Пред. ${document.getElementById("sumPrevS3").textContent}; Тек. ${document.getElementById("sumCurrS3").textContent}; Δ ${document.getElementById("sumDeltaS3").textContent.replace(/<[^>]*>/g,'')}</div>
      <hr style="border:none;border-top:1px solid #E2E8F0;margin:20px 0"/>
      <h3 style="color:#0033A0">В том числе: динамика по ПАО «Ростелеком»</h3>
      <div>${listAll(sortedS4)}</div>
      <div style="margin-top:12px;font-weight:700">Итого: Пред. ${document.getElementById("sumPrevS4").textContent}; Тек. ${document.getElementById("sumCurrS4").textContent}; Δ ${document.getElementById("sumDeltaS4").textContent.replace(/<[^>]*>/g,'')}</div>
    `;
  }

  /* ==================== Main Init ==================== */
  let DATA = null;

  // File input handlers
  document.getElementById("filePrev").addEventListener("change", (e) => {
    const file = e.target.files[0];
    const wrapper = document.getElementById("prevWrapper");
    const nameEl = document.getElementById("prevFileName");
    
    if(file){
      wrapper.classList.add("has-file");
      nameEl.textContent = file.name;
    } else {
      wrapper.classList.remove("has-file");
      nameEl.textContent = "PDF не выбран";
    }
    checkAnalyzeButton();
  });

  document.getElementById("fileCurr").addEventListener("change", (e) => {
    const file = e.target.files[0];
    const wrapper = document.getElementById("currWrapper");
    const nameEl = document.getElementById("currFileName");
    
    if(file){
      wrapper.classList.add("has-file");
      nameEl.textContent = file.name;
    } else {
      wrapper.classList.remove("has-file");
      nameEl.textContent = "PDF не выбран";
    }
    checkAnalyzeButton();
  });

  function checkAnalyzeButton(){
    const btn = document.getElementById("btnParse");
    const hasBoth = document.getElementById("filePrev").files[0] && 
                    document.getElementById("fileCurr").files[0];
    btn.disabled = !hasBoth;
  }

  // Parse button
  document.getElementById("btnParse").addEventListener("click", async () => {
    const fPrev = document.getElementById("filePrev").files[0];
    const fCurr = document.getElementById("fileCurr").files[0];
    
    if(!fPrev || !fCurr){
      document.getElementById("errorMsg").textContent = "Загрузите оба PDF файла";
      document.getElementById("errorMsg").classList.add("show");
      return;
    }

    try{
      document.getElementById("loadingMsg").classList.add("show");
      document.getElementById("errorMsg").classList.remove("show");

      const [pPrev, pCurr] = await Promise.all([pdfToPages(fPrev), pdfToPages(fCurr)]);
      const prev = parseReportByPages(pPrev);
      const curr = parseReportByPages(pCurr);
      const dyn = computeDynamics(curr, prev);
      DATA = {prev, curr, dyn};

      document.getElementById("dates").textContent = `Предыдущий: ${prev.date} · Текущий: ${curr.date}`;
      renderKpis(curr, prev, dyn);
      renderBranchesTable(dyn.branchRows, "#tblBranches tbody", "sumPrev", "sumCurr", "sumDelta");
      renderBranchesTable(dyn.branchRowsS3, "#tblBranchesS3 tbody", "sumPrevS3", "sumCurrS3", "sumDeltaS3");
      renderBranchesTable(dyn.branchRowsS4, "#tblBranchesS4 tbody", "sumPrevS4", "sumCurrS4", "sumDeltaS4");
      renderCharts(curr, prev, dyn);
      renderStagesTables(dyn);
      buildPresentationHTML(curr, prev, dyn);
      document.getElementById("briefDates").textContent = `Предыдущий: ${prev.date} · Текущий: ${curr.date}`;
      buildSummaryBlocks(curr, prev, dyn);
      await injectPlanFactHTML();

      document.getElementById("loadingMsg").classList.remove("show");
    }catch(e){
      console.error(e);
      document.getElementById("loadingMsg").classList.remove("show");
      document.getElementById("errorMsg").textContent = "Ошибка разбора PDF. Проверьте формат отчётов.";
      document.getElementById("errorMsg").classList.add("show");
    }
  });

  // Export buttons
  document.getElementById("exportPresPDF").addEventListener("click", async () => {
    if(!DATA) return alert("Сначала проанализируйте отчёты");
    await exportPresPDF();
  });

  document.getElementById("exportBriefPDF").addEventListener("click", async () => {
    if(!DATA) return alert("Сначала проанализируйте отчёты");
    await exportBriefPDF();
  });

  document.getElementById("exportWordHTML").addEventListener("click", () => {
    if(!DATA) return alert("Сначала проанализируйте отчёты");
    exportWordHTML();
  });

  document.getElementById("exportPresHTML").addEventListener("click", () => {
    if(!DATA) return alert("Сначала проанализируйте отчёты");
    exportPresHTML();
  });

  // Compact mode toggle
  document.getElementById("btnCompact").addEventListener("click", () => {
    document.body.classList.toggle("compact");
    const btn = document.getElementById("btnCompact");
    if(document.body.classList.contains("compact")){
      btn.textContent = "Обычный режим";
    } else {
      btn.textContent = "Компактный режим";
    }
  });

  // Initialize Plan-Fact on page load
  window.addEventListener('DOMContentLoaded', () => {
    injectPlanFactHTML();
  });
  </script>
</body>
</html> = new Intl.Collator("ru", {sensitivity:"base"});
    const sortedBranches = [...BRANCHES].sort((a,b) => collator.compare(a,b));
    
    const labels = sortedBranches;
    const prevS2 = labels.map(b=>prev.p2.branches.get(b)?.total||0);
    const currS2 = labels.map(b=>curr.p2.branches.get(b)?.total||0);

    if(chartBranches) chartBranches.destroy();
    chartBranches = new Chart(document.getElementById("chartBranches"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая", data:prevS2, backgroundColor:"rgba(100, 116, 139, 0.8)", borderRadius:4},
        {label:"Текущая", data:currS2, backgroundColor:"rgba(0, 51, 160, 0.9)", borderRadius:4}
      ]},
      options: chartOpts()
    });

    const prevS3 = labels.map(b=>prev.p3.branches.get(b)?.total||0);
    const currS3 = labels.map(b=>curr.p3.branches.get(b)?.total||0);
    if(chartBranchesS3) chartBranchesS3.destroy();
    chartBranchesS3 = new Chart(document.getElementById("chartBranchesS3"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая", data:prevS3, backgroundColor:"rgba(100, 116, 139, 0.8)", borderRadius:4},
        {label:"Текущая", data:currS3, backgroundColor:"rgba(0, 51, 160, 0.9)", borderRadius:4}
      ]},
      options: chartOpts()
    });

    const prevS4 = labels.map(b=>prev.p4.branches.get(b)?.total||0);
    const currS4 = labels.map(b=>curr.p4.branches.get(b)?.total||0);
    if(chartBranchesS4) chartBranchesS4.destroy();
    chartBranchesS4 = new Chart(document.getElementById("chartBranchesS4"), {
      type:"bar",
      data:{labels, datasets:[
        {label:"Предыдущая", data:prevS4, backgroundColor:"rgba(100, 116, 139, 0.8)", borderRadius:4},
        {label:"Текущая", data:currS4, backgroundColor:"rgba(0, 51, 160, 0.9)", borderRadius:4}
      ]},
      options: chartOpts()
    });

    const rtkD = labels.map(b => {
      const row = dyn.rtkRows.find(x => x.b === b);
      return row ? row.d : 0;
    });
    if(chartRTKDelta) chartRTKDelta.destroy();
    chartRTKDelta = new Chart(document.getElementById("chartRTKDelta"), {
      type:"bar",
      data:{labels, datasets:[{
        label:"Δ ПАО «Ростелеком»",
        data:rtkD,
        backgroundColor: rtkD.map(v=>v>0?"rgba(5, 150, 105, 0.8)":"rgba(220, 38, 38, 0.8)"),
        borderRadius:4
      }]},
      options: chartOpts()
    });
  }

  function renderStagesTables(dyn){
    const fill = (id, rows) => {
      const tbody = document.querySelector(id + " tbody");
      tbody.innerHTML = rows.map(r=>{
        const p = Number(r.p)||0, c = Number(r.c)||0, d = c - p;
        const cls = d>0?"up":(d<0?"down":"muted");
        return `<tr><td>${r.stage}</td><td>${fmt(p)}</td><td>${fmt(c)}</td><td><span class="kpi-delta ${cls}">${d>0?"+":""}${fmt(d)}</span></td></tr>`;
      }).join("");
    };
    fill("#tblStagesS2", dyn.stagesS2);
    fill("#tblStagesS4", dyn.stagesS4);
  }

  /* ==================== Print HTML Generation with Charts + Tables ==================== */
  function createSlideWithGraphAndTable(title, graphImg, tableHtml) {
    return `
      <div style="page-break-before: always; margin-bottom: 30px;">
        <h2 style="color:#0033A0;font-size:24px;margin-bottom:20px">${title}</h2>
        <div style="display:flex;gap:20px;align-items:flex-start">
          <div style="flex:1;background:#f8fafc;border-radius:12px;padding:15px">
            <img src="${graphImg}" alt="График" style="width:100%;height:auto;max-height:400px;object-fit:contain"/>
          </div>
          <div style="flex:1">
            ${tableHtml}
          </div>
        </div>
      </div>`;
  }

  function presTableHTML(title, rows, sumIds, noTitle = false){
    // Sort rows alphabetically
    const collator = new Intl.Collator("ru", {sensitivity:"base"});
    const sortedRows = [...rows].sort((a,b) => collator.compare(a.b, b.b));
    
    const titleHtml = noTitle ? '' : `<div style="font-weight:700;margin:0 0 8px;font-size:14px;color:#0F172A">${title}</div>`;
    
    return titleHtml + `
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead><tr style="background:linear-gradient(135deg,#0033A0,#0A47C6);color:white">
          <th style="text-align:left;padding:8px;font-size:11px">Филиал</th>
          <th style="text-align:right;padding:8px;font-size:11px">Пред.</th>
          <th style="text-align:right;padding:8px;font-size:11px">Тек.</th>
          <th style="text-align:right;padding:8px;font-size:11px">Δ</th>
        </tr></thead>
        <tbody>
          ${sortedRows.map(r => {
            const p=Number(r.p)||0,c=Number(r.c)||0,d=c-p;
            return `<tr style="border-bottom:1px solid #E2E8F0">
              <td style="padding:6px;font-size:11px">${r.b}</td>
              <td style="padding:6px;text-align:right;font-size:11px">${fmt(p)}</td>
              <td style="padding:6px;text-align:right;font-size:11px">${fmt(c)}</td>
              <td style="padding:6px;text-align:right;color:${d>0?'#059669':(d<0?'#DC2626':'#64748B')};font-weight:600;font-size:11px">${d>0?'+':''}${fmt(d)}</td>
            </tr>`;
          }).join("")}
        </tbody>
        <tfoot>
          <tr style="background:#F5F7FA;font-weight:700">
            <td style="padding:8px;font-size:11px">Итого</td>
            <td style="padding:8px;text-align:right;font-size:11px">${document.getElementById(sumIds[0]).textContent}</td>
            <td style="padding:8px;text-align:right;font-size:11px">${document.getElementById(sumIds[1]).textContent}</td>
            <td style="padding:8px;text-align:right;font-size:11px">${document.getElementById(sumIds[2]).textContent.replace(/<[^>]*>/g,'')}</td>
          </tr>
        </tfoot>
      </table>`;
  }

  /* ==================== Google Sheets Plan-Fact ==================== */
  const SHEET_HTML_URL = "https://docs.google.com/spreadsheets/d/1Y9bM7zLRf_gonMUgfQLl57Iu3NgPa78rBXnpxkKLvO0/gviz/tq?tqx=out:html";
  async function injectPlanFactHTML(){
    try{
      const res = await fetch(SHEET_HTML_URL, {cache:"no-store", mode:"cors"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const html = await res.text();
      const tmp = document.createElement("div");
      tmp.innerHTML = html;
      const table = tmp.querySelector("table");
      if(!table) throw new Error("Таблица не найдена");

      // Style the table with center alignment
      table.style.width = "100%";
      table.style.borderCollapse = "collapse";
      table.style.fontSize = "14px";
      table.style.textAlign = "center";
      
      // Style headers
      const headers = table.querySelectorAll("th");
      headers.forEach(th => {
        th.style.background = "linear-gradient(135deg, #0033A0, #0A47C6)";
        th.style.color = "white";
        th.style.padding = "12px";
        th.style.fontWeight = "600";
        th.style.textAlign = "center";
      });
      
      // Style cells
      const cells = table.querySelectorAll("td");
      cells.forEach(td => {
        td.style.padding = "10px";
        td.style.borderBottom = "1px solid #E2E8F0";
        td.style.textAlign = "center";
      });

      // Add to main page
      document.getElementById("mainPlanFactInner").innerHTML = table.outerHTML;
      
      // Add to print areas
      const caption = `<div style="font-weight:700;margin:16px 0 8px;font-size:16px;color:#0F172A;text-align:center">План-Факт выполнения показателей</div>`;
      document.getElementById("presPlanFactInner").innerHTML = caption + table.outerHTML;
      document.getElementById("briefPlanFactInner").innerHTML = caption + table.outerHTML;
    }catch(e){
      console.warn("План-Факт недоступен:", e);
      const fallback = `<div style="padding:20px;background:rgba(2,132,199,0.05);border:1px solid rgba(2,132,199,0.2);border-radius:8px;color:#0284C7;text-align:center">
        <strong>План-Факт временно недоступен</strong><br/>
        <a href="https://docs.google.com/spreadsheets/d/1Y9bM7zLRf_gonMUgfQLl57Iu3NgPa78rBXnpxkKLvO0/edit" target="_blank" style="color:#0284C7">Открыть таблицу →</a>
      </div>`;
      document.getElementById("mainPlanFactInner").innerHTML = fallback;
      document.getElementById("presPlanFactInner").innerHTML = fallback;
      document.getElementById("briefPlanFactInner").innerHTML = fallback;
    }
  }

  /* ==================== Export Functions ==================== */
  function exportPresHTML(){
    if(!DATA) return alert("Сначала проанализируйте отчёты");
    const {curr, prev, dyn} = DATA;

    // Wait for charts to render and get images
    setTimeout(() => {
      const imgS2 = document.getElementById("chartBranches").toDataURL("image/png", 1.0);
      const imgS3 = document.getElementById("chartBranchesS3").toDataURL("image/png", 1.0);
      const imgS4 = document.getElementById("chartBranchesS4").toDataURL("image/png", 1.0);
      const imgRTK = document.getElementById("chartRTKDelta").toDataURL("image/png", 1.0);

      const planfactHTML = document.getElementById("presPlanFactInner").innerHTML || "";

      // Sort for presentation
      const collator = new Intl.Collator("ru", {sensitivity:"base"});
      const s2Sorted = [...dyn.branchRows].sort((a,b) => collator.compare(a.b, b.b));
      const s3Sorted = [...(dyn.branchRowsS3||[])].sort((a,b) => collator.compare(a.b, b.b));
      const s4Sorted = [...(dyn.branchRowsS4||[])].sort((a,b) => collator.compare(a.b, b.b));
      const s2BranchStagesSorted = [...dyn.s2BranchStages].sort((a,b)=>collator.compare(a.b,b.b));

      const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
      const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

      // Create slides with graph on left, table on right
      const slide2 = createSlideWithGraphAndTable(
        "Динамика выявления бездоговорного размещения ВОЛС (итого)",
        imgS2,
        presTableHTML("", s2Sorted, ["sumPrev","sumCurr","sumDelta"], true)
      );

      const slide3 = createSlideWithGraphAndTable(
        "В том числе: динамика по Приказу №425",
        imgS3,
        presTableHTML("", s3Sorted, ["sumPrevS3","sumCurrS3","sumDeltaS3"], true)
      );

      const slide4 = createSlideWithGraphAndTable(
        "В том числе: динамика по ПАО «Ростелеком»",
        imgS4,
        presTableHTML("", s4Sorted, ["sumPrevS4","sumCurrS4","sumDeltaS4"], true)
      );

      const presHTML = `<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Презентация ВОЛС - ${curr.date}</title>
  <style>
    body{font-family:'Inter','Segoe UI',sans-serif;margin:0;padding:40px;background:white}
    h1{color:#0033A0;font-size:36px;margin:0 0 30px;font-weight:800}
    h2{color:#0033A0;font-size:24px;margin:30px 0 20px;font-weight:700}
    table{width:100%;border-collapse:collapse}
    th{background:#0033A0;color:white;padding:8px;text-align:left;font-size:11px}
    td{padding:6px;border-bottom:1px solid #e5e7eb;font-size:11px}
    tfoot td{font-weight:700;background:#f1f5f9}
    img{max-width:100%;height:auto}
    .page-break{page-break-before:always}
    .kpi-row{display:flex;justify-content:space-around;flex-wrap:wrap;margin:30px 0}
    .kpi-box{text-align:center;padding:20px;background:#f8fafc;border-radius:12px;min-width:150px;margin:10px}
    .logo{width:80px;height:80px;background:#0033A0;border-radius:50%;margin:0 auto 20px}
  </style>
</head>
<body>
  <!-- Page 1: Title + Plan-Fact + KPIs -->
  <div style="text-align:center;padding:60px 0">
    <div class="logo"></div>
    <h1>АО «Россети Кубань»<br/>Выполнение плановых показателей БП<br/>по размещению ВОЛС на ВЛ</h1>
    <div style="text-align:center;margin:40px 0">
      ${planfactHTML}
    </div>
    <div class="kpi-row">
      <div class="kpi-box">
        <div style="font-size:14px;color:#64748B;margin-bottom:8px">В работе всего</div>
        <div style="font-size:36px;font-weight:800;color:#0F172A">${fmt(curr.p1.totals.in_work_total)}</div>
        <div style="font-size:16px;font-weight:600;color:${dyn.in_work_total>0?'#059669':'#DC2626'}">${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)}</div>
      </div>
      <div class="kpi-box">
        <div style="font-size:14px;color:#64748B;margin-bottom:8px">Выявлено за неделю</div>
        <div style="font-size:36px;font-weight:800;color:#0F172A">${fmt(dyn.found_week)}</div>
        <div style="font-size:16px;font-weight:600;color:${dyn.found_week>0?'#059669':'#64748B'}">${dyn.found_week>0?'+':''}${fmt(dyn.found_week)}</div>
      </div>
      <div class="kpi-box">
        <div style="font-size:14px;color:#64748B;margin-bottom:8px">Закрыто за неделю</div>
        <div style="font-size:36px;font-weight:800;color:#0F172A">${fmt(eff)}</div>
        <div style="font-size:16px;font-weight:600;color:${eff>0?'#059669':'#64748B'}">${eff>0?'+':''}${fmt(eff)}</div>
      </div>
      <div class="kpi-box">
        <div style="font-size:14px;color:#64748B;margin-bottom:8px">ПАО «Ростелеком»</div>
        <div style="font-size:36px;font-weight:800;color:#0F172A">${fmt(curr.p1.totals.rtk_in_work)}</div>
        <div style="font-size:16px;font-weight:600;color:#64748B">${rtkShare.toFixed(1)}%</div>
      </div>
    </div>
  </div>

  ${slide2}
  ${slide3}
  ${slide4}
  
  <!-- RTK Delta -->
  <div class="page-break">
    <h2>ПАО «Ростелеком» - изменения по филиалам</h2>
    <div style="text-align:center;margin:30px 0">
      <img src="${imgRTK}" alt="График" style="max-width:800px"/>
    </div>
  </div>

  <!-- Status Matrix and Totals -->
  <div class="page-break">
    <h2>Динамика по статусам</h2>
    ${stageMatrixHTML("Матрица изменений по филиалам", s2BranchStagesSorted)}
    <div style="margin-top:30px">
      ${stageTotalsHTML("Итоги по статусам", dyn.stagesS2)}
    </div>
  </div>
</body>
</html>`;

      const blob = new Blob([presHTML], {type: 'text/html; charset=utf-8'});
      triggerDownload(blob, `Презентация_ВОЛС_${curr.date.replace(/\./g,'-')}.html`);
      showExportStatus("HTML презентация сохранена");
    }, 100);
  }

  function stageMatrixHTML(title, branchStages){
    const cols = STATUS_KEYS;
    const head = cols.map(k=>`<th style="text-align:right;padding:6px;white-space:nowrap;font-size:10px">${SHORT_STAGE_TITLE(k)}</th>`).join("");
    let totals = {}; cols.forEach(k=>totals[k]=0);

    const collator = new Intl.Collator("ru", {sensitivity:"base"});
    const sortedBranches = [...branchStages].sort((a,b) => collator.compare(a.b, b.b));

    const body = sortedBranches.map(row=>{
      const cells = cols.map(k=>{
        const d = (row.by[k]?.d)||0; totals[k]+=d;
        return `<td style="padding:4px;text-align:right;color:${d>0?'#059669':(d<0?'#DC2626':'#64748B')};font-weight:600;font-size:10px">${d>0?'+':''}${fmt(d)}</td>`;
      }).join("");
      return `<tr style="border-bottom:1px solid #E2E8F0"><td style="padding:6px;font-size:11px">${row.b}</td>${cells}</tr>`;
    }).join("");

    const totalRow = `<tr style="background:#F5F7FA;font-weight:700">
      <td style="padding:6px">Итого Δ</td>
      ${cols.map(k=>`<td style="padding:4px;text-align:right;color:${totals[k]>0?'#059669':(totals[k]<0?'#DC2626':'#64748B')};font-size:10px">${totals[k]>0?'+':''}${fmt(totals[k])}</td>`).join("")}
    </tr>`;

    return `<div style="font-weight:700;margin:16px 0 8px;font-size:14px;color:#0F172A">${title}</div>
      <div style="overflow-x:auto">
        <table style="width:100%;border-collapse:collapse">
          <thead><tr style="background:linear-gradient(135deg,#0033A0,#0A47C6);color:white">
            <th style="text-align:left;padding:6px;font-size:11px">Филиал</th>${head}
          </tr></thead>
          <tbody>${body}</tbody>
          <tfoot>${totalRow}</tfoot>
        </table>
      </div>`;
  }

  function stageTotalsHTML(title, totalsArray){
    return `<div style="margin:16px 0 8px;font-weight:700;font-size:14px;color:#0F172A">${title}</div>
      <table style="width:100%;border-collapse:collapse;font-size:12px">
        <thead><tr style="background:linear-gradient(135deg,#0033A0,#0A47C6);color:white">
          <th style="text-align:left;padding:8px">Стадия</th>
          <th style="text-align:right;padding:8px">Пред.</th>
          <th style="text-align:right;padding:8px">Тек.</th>
          <th style="text-align:right;padding:8px">Δ</th>
        </tr></thead>
        <tbody>
          ${totalsArray.map(r=>{
            const p=Number(r.p)||0,c=Number(r.c)||0,d=c-p;
            return `<tr style="border-bottom:1px solid #E2E8F0">
              <td style="padding:6px">${r.stage}</td>
              <td style="padding:6px;text-align:right">${fmt(p)}</td>
              <td style="padding:6px;text-align:right">${fmt(c)}</td>
              <td style="padding:6px;text-align:right;color:${d>0?'#059669':(d<0?'#DC2626':'#64748B')};font-weight:600">${d>0?'+':''}${fmt(d)}</td>
            </tr>`;
          }).join("")}
        </tbody>
      </table>`;
  }

  async function exportPresPDF(){
    // Similar structure but for PDF export
    const el = document.getElementById("presentationPrint");
    el.style.display = "block";
    
    // Wait for charts and prepare content
    setTimeout(async () => {
      const imgS2 = document.getElementById("chartBranches").toDataURL("image/png", 1.0);
      const imgS3 = document.getElementById("chartBranchesS3").toDataURL("image/png", 1.0);
      const imgS4 = document.getElementById("chartBranchesS4").toDataURL("image/png", 1.0);
      
      // Add chart images to print area
      document.getElementById("presTable").innerHTML = createSlideWithGraphAndTable(
        "Динамика по филиалам (всего)",
        imgS2,
        presTableHTML("", DATA.dyn.branchRows, ["sumPrev","sumCurr","sumDelta"], true)
      );
      
      document.getElementById("presTableS3").innerHTML = createSlideWithGraphAndTable(
        "В том числе: динамика по Приказу №425",
        imgS3,
        presTableHTML("", DATA.dyn.branchRowsS3, ["sumPrevS3","sumCurrS3","sumDeltaS3"], true)
      );
      
      document.getElementById("presTableS4").innerHTML = createSlideWithGraphAndTable(
        "В том числе: динамика по ПАО «Ростелеком»",
        imgS4,
        presTableHTML("", DATA.dyn.branchRowsS4, ["sumPrevS4","sumCurrS4","sumDeltaS4"], true)
      );
      
      await html2pdf().from(el).set({
        margin: 10,
        filename: "Презентация_ВОЛС.pdf",
        image: {type: 'jpeg', quality: 0.98},
        html2canvas: {scale: 2.5, useCORS: true},
        jsPDF: {unit: 'mm', format: 'a4', orientation: 'landscape', compress: true},
        pagebreak: { mode: ['css','legacy'], avoid: ['tr','.avoid-break'] }
      }).save();
      
      el.style.display = "none";
      showExportStatus("PDF презентации сохранен");
    }, 100);
  }

  async function exportBriefPDF(){
    const el = document.getElementById("summaryPrint");
    el.style.display = "block";
    await html2pdf().from(el).set({
      margin: 10,
      filename: "Полный_табличный_отчет_ВОЛС.pdf",
      image: {type: 'jpeg', quality: 0.98},
      html2canvas: {scale: 2.5, useCORS: true},
      jsPDF: {unit: 'mm', format: 'a4', orientation: 'portrait', compress: true},
      pagebreak: { mode: ['css','legacy'], avoid: ['tr','.avoid-break'] }
    }).save();
    el.style.display = "none";
    showExportStatus("Полный табличный PDF сохранен");
  }

  function exportWordHTML(){
    if(!DATA) return alert("Сначала проанализируйте отчёты");
    const {curr, prev, dyn} = DATA;
    
    // Wait for charts
    setTimeout(() => {
      const imgS2 = document.getElementById("chartBranches").toDataURL("image/png", 1.0);
      const imgS3 = document.getElementById("chartBranchesS3").toDataURL("image/png", 1.0);
      const imgS4 = document.getElementById("chartBranchesS4").toDataURL("image/png", 1.0);
      const imgRTK = document.getElementById("chartRTKDelta").toDataURL("image/png", 1.0);
      
      const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
      const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

      const planfactHTML = document.getElementById("presPlanFactInner").innerHTML || "<div>План-Факт недоступен</div>";

      // Sort branches
      const collator = new Intl.Collator("ru", {sensitivity:"base"});
      const sortedS2 = [...dyn.branchRows].sort((a,b) => collator.compare(a.b, b.b));
      const sortedS3 = [...(dyn.branchRowsS3||[])].sort((a,b) => collator.compare(a.b, b.b));
      const sortedS4 = [...(dyn.branchRowsS4||[])].sort((a,b) => collator.compare(a.b, b.b));

      const htmlDoc = `<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Отчет ВОЛС - ${curr.date}</title>
<style>
  body{font-family:'Segoe UI',Arial,sans-serif;max-width:1200px;margin:0 auto;padding:30px;line-height:1.6;color:#333}
  h1{color:#0033A0;border-bottom:3px solid #0033A0;padding-bottom:12px;font-size:28px}
  h2{color:#0033A0;margin-top:32px;font-size:22px}
  h3{color:#333;margin-top:24px;font-size:18px}
  table{width:100%;border-collapse:collapse;margin:20px 0;font-size:14px}
  th,td{border:1px solid #ddd;padding:10px;text-align:left}
  th{background:#0033A0;color:white;font-weight:600}
  tr:nth-child(even){background:#f8f9fa}
  .positive{color:#059669;font-weight:700}
  .negative{color:#DC2626;font-weight:700}
  .info-box{background:#f0f6ff;border-left:5px solid #0033A0;padding:15px;margin:20px 0;border-radius:4px}
  .footer{margin-top:40px;padding-top:20px;border-top:2px solid #e5e7eb;font-size:13px;color:#666}
  .chart-section{display:flex;gap:20px;margin:20px 0}
  .chart-box{flex:1}
  .table-box{flex:1}
  img{max-width:100%;height:auto}
</style></head>
<body>
<h1>АО «Россети Кубань» — Отчет по ВОЛС</h1>
<div class="info-box">
  <p><strong>Отчетный период:</strong><br/>
  Предыдущая неделя: ${prev.date}<br/>
  Текущая неделя: ${curr.date}</p>
</div>

<h2>План-Факт выполнения показателей</h2>
${planfactHTML}

<h2>Основные показатели</h2>
<ul style="line-height:1.8">
  <li>В работе всего: <strong>${fmt(curr.p1.totals.in_work_total)}</strong> <span class="${dyn.in_work_total>=0?'positive':'negative'}">(${dyn.in_work_total>0?'+':''}${fmt(dyn.in_work_total)})</span></li>
  <li>Выявлено за неделю: <strong>${fmt(dyn.found_week)}</strong></li>
  <li>Закрыто за неделю: <strong>${fmt(eff)}</strong></li>
  <li>ПАО «Ростелеком» в работе: <strong>${fmt(curr.p1.totals.rtk_in_work)}</strong> <span class="${dyn.rtk_in_work>=0?'positive':'negative'}">(${dyn.rtk_in_work>0?'+':''}${fmt(dyn.rtk_in_work)})</span>; доля <strong>${rtkShare.toFixed(1)}%</strong></li>
</ul>

<h2>Динамика по филиалам (всего)</h2>
<div class="chart-section">
  <div class="chart-box">
    <img src="${imgS2}" alt="График динамики"/>
  </div>
  <div class="table-box">
    <table>
      <thead><tr><th>Филиал</th><th>Предыдущая</th><th>Текущая</th><th>Изменение</th></tr></thead>
      <tbody>${sortedS2.map(r=>`<tr><td>${r.b}</td><td>${fmt(r.p)}</td><td>${fmt(r.c)}</td><td class="${r.d>0?'positive':r.d<0?'negative':''}">${r.d>0?'+':''}${fmt(r.d)}</td></tr>`).join("")}</tbody>
      <tfoot><tr style="font-weight:700;background:#f0f0f0"><td>ИТОГО</td><td>${document.getElementById("sumPrev").textContent}</td><td>${document.getElementById("sumCurr").textContent}</td><td>${document.getElementById("sumDelta").textContent.replace(/<[^>]*>/g,'')}</td></tr></tfoot>
    </table>
  </div>
</div>

<h2>В том числе: динамика по Приказу №425</h2>
<div class="chart-section">
  <div class="chart-box">
    <img src="${imgS3}" alt="График Приказ 425"/>
  </div>
  <div class="table-box">
    <table>
      <thead><tr><th>Филиал</th><th>Предыдущая</th><th>Текущая</th><th>Изменение</th></tr></thead>
      <tbody>${sortedS3.map(r=>`<tr><td>${r.b}</td><td>${fmt(r.p)}</td><td>${fmt(r.c)}</td><td class="${r.d>0?'positive':r.d<0?'negative':''}">${r.d>0?'+':''}${fmt(r.d)}</td></tr>`).join("")}</tbody>
      <tfoot><tr style="font-weight:700;background:#f0f0f0"><td>ИТОГО</td><td>${document.getElementById("sumPrevS3").textContent}</td><td>${document.getElementById("sumCurrS3").textContent}</td><td>${document.getElementById("sumDeltaS3").textContent.replace(/<[^>]*>/g,'')}</td></tr></tfoot>
    </table>
  </div>
</div>

<h2>В том числе: динамика по ПАО «Ростелеком»</h2>
<div class="chart-section">
  <div class="chart-box">
    <img src="${imgS4}" alt="График Ростелеком"/>
  </div>
  <div class="table-box">
    <table>
      <thead><tr><th>Филиал</th><th>Предыдущая</th><th>Текущая</th><th>Изменение</th></tr></thead>
      <tbody>${sortedS4.map(r=>`<tr><td>${r.b}</td><td>${fmt(r.p)}</td><td>${fmt(r.c)}</td><td class="${r.d>0?'positive':r.d<0?'negative':''}">${r.d>0?'+':''}${fmt(r.d)}</td></tr>`).join("")}</tbody>
      <tfoot><tr style="font-weight:700;background:#f0f0f0"><td>ИТОГО</td><td>${document.getElementById("sumPrevS4").textContent}</td><td>${document.getElementById("sumCurrS4").textContent}</td><td>${document.getElementById("sumDeltaS4").textContent.replace(/<[^>]*>/g,'')}</td></tr></tfoot>
    </table>
  </div>
</div>

<h2>ПАО «Ростелеком» - изменения по филиалам</h2>
<div style="text-align:center;margin:20px 0">
  <img src="${imgRTK}" alt="График изменений РТК"/>
</div>

<h2>Динамика по статусам</h2>
<table>
  <thead><tr><th>Статус</th><th>Пред.</th><th>Тек.</th><th>Δ</th></tr></thead>
  <tbody>${(dyn.stagesS2||[]).map(r=>`<tr><td>${r.stage}</td><td>${fmt(r.p)}</td><td>${fmt(r.c)}</td><td class="${r.d>0?'positive':r.d<0?'negative':''}">${r.d>0?'+':''}${fmt(r.d)}</td></tr>`).join("")}</tbody>
</table>

<div class="footer">
  <p><strong>Примечание:</strong> Отчет сформирован автоматически на основе загруженных PDF-файлов.<br/>
  Дата формирования: ${new Date().toLocaleDateString('ru-RU')}</p>
</div>
</body></html>`;

      const blob = new Blob([htmlDoc], {type: 'text/html; charset=utf-8'});
      triggerDownload(blob, `Отчет_ВОЛС_${curr.date.replace(/\./g,'-')}.html`);
      showExportStatus("HTML отчет для Word сохранен");
    }, 100);
  }

  /* ==================== Helper Functions ==================== */
  function triggerDownload(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  function showExportStatus(message){
    const status = document.getElementById("exportStatus");
    status.textContent = message;
    status.classList.add("show");
    setTimeout(()=>{ status.classList.remove("show"); }, 3000);
  }

  function buildPresentationHTML(curr, prev, dyn){
    document.getElementById("presDates").textContent = `Пред.: ${prev.date} · Тек.: ${curr.date}`;

    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    const rtkShare = curr.p1.totals.in_work_total ? (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

    const box = (t, val, delta) => `<div style="display:inline-block;border:1px solid #E2E8F0;border-radius:12px;padding:16px;margin:8px;background:linear-gradient(135deg,white,#FAFBFC)">
      <div style="color:#64748B;font-size:12px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600">${t}</div>
      <div style="font-weight:800;font-size:28px;color:#0F172A;margin:8px 0">${typeof val === "number" ? fmt(val) : val}</div>
      <div style="font-size:14px;font-weight:600;padding:4px 8px;border-radius:6px;display:inline-block;background:${delta>0?'rgba(5,150,105,0.1)':(delta<0?'rgba(220,38,38,0.1)':'#F5F7FA')};color:${delta > 0 ? '#059669' : (delta < 0 ? '#DC2626' : '#64748B')}">
        ${delta > 0 ? '+' : ''}${fmt(delta)}
      </div>
    </div>`;

    document.getElementById("presKpis").innerHTML =
      box("В работе всего, шт.", curr.p1.totals.in_work_total, dyn.in_work_total) +
      box("Выявлено за неделю, шт.", dyn.found_week, dyn.found_week) +
      box("Закрыто за неделю, шт.", eff, eff) +
      box("ПАО «Ростелеком», шт. (%)", `${fmt(curr.p1.totals.rtk_in_work)} (${rtkShare.toFixed(1)}%)`, dyn.rtk_in_work);

    const s2Matrix = stageMatrixHTML("Динамика по статусам (Δ)", dyn.s2BranchStages);
    const s2Totals = stageTotalsHTML("Итоги по статусам", dyn.stagesS2);
    document.getElementById("presStages").innerHTML = s2Matrix + s2Totals;
  }

  function buildSummaryBlocks(curr, prev, dyn){
    const blocks = document.getElementById("briefBlocks");
    const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
    
    // Sort branches alphabetically
    const collator
