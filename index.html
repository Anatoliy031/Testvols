<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –í–û–õ–° | –ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª</title>

  <!-- –®—Ä–∏—Ñ—Ç—ã -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

  <style>
    /* ====== –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∏–∑–∞–π–Ω–∞ ====== */
    :root {
      /* –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ */
      --primary: #1e40af;
      --primary-dark: #1e3a8a;
      --primary-light: #3b82f6;
      --accent: #06b6d4;
      --accent-dark: #0891b2;
      
      /* –°—Ç–∞—Ç—É—Å–Ω—ã–µ —Ü–≤–µ—Ç–∞ */
      --success: #10b981;
      --success-bg: #ecfdf5;
      --warning: #f59e0b;
      --warning-bg: #fffbeb;
      --danger: #ef4444;
      --danger-bg: #fef2f2;
      
      /* –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ */
      --bg: #f8fafc;
      --surface: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --text-muted: #64748b;
      --text-light: #94a3b8;
      
      /* –¢–µ–Ω–∏ –∏ —Ä–∞–¥–∏—É—Å—ã */
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
      --radius: 0.75rem;
      --radius-lg: 1rem;
    }

    /* ====== –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ ====== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
    }

    /* ====== –®–∞–ø–∫–∞ ====== */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: var(--shadow-lg);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .logo {
      width: 2.5rem;
      height: 2.5rem;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 900;
      font-size: 1rem;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-title {
      font-weight: 800;
      font-size: 0.875rem;
      letter-spacing: -0.025em;
    }

    .logo-subtitle {
      font-size: 0.75rem;
      opacity: 0.9;
      display: none;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .status-badge {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      padding: 0.375rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    .status-dot {
      width: 0.375rem;
      height: 0.375rem;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ====== –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ====== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* ====== –ù–∞–≤–∏–≥–∞—Ü–∏—è (—Ç–∞–±—ã) ====== */
    .nav-tabs {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 0.375rem;
      display: flex;
      gap: 0.25rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .nav-tab {
      flex: 1;
      min-width: max-content;
      padding: 0.625rem 1rem;
      background: transparent;
      border: none;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      white-space: nowrap;
    }

    .nav-tab:hover {
      background: var(--bg);
    }

    .nav-tab.active {
      background: var(--primary);
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ====== –ö–∞—Ä—Ç–æ—á–∫–∏ ====== */
    .card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      box-shadow: var(--shadow);
      transition: all 0.3s;
      margin-bottom: 1rem;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card-subtitle {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    /* ====== –°–µ—Ç–∫–∞ ====== */
    .grid {
      display: grid;
      gap: 1rem;
    }

    .grid-2 {
      grid-template-columns: repeat(2, 1fr);
    }

    .grid-3 {
      grid-template-columns: repeat(3, 1fr);
    }

    .grid-4 {
      grid-template-columns: repeat(4, 1fr);
    }

    /* ====== –ú–µ—Ç—Ä–∏–∫–∏ ====== */
    .metric-card {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      transition: all 0.3s;
    }

    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
    }

    .metric-icon {
      width: 2.5rem;
      height: 2.5rem;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      border-radius: var(--radius);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.25rem;
      margin-bottom: 0.75rem;
    }

    .metric-label {
      color: var(--text-muted);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .metric-value {
      font-size: 1.75rem;
      font-weight: 800;
      color: var(--text);
      margin: 0.375rem 0;
    }

    .metric-change {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.25rem 0.625rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .metric-change.positive {
      background: var(--success-bg);
      color: var(--success);
    }

    .metric-change.negative {
      background: var(--danger-bg);
      color: var(--danger);
    }

    .metric-change.neutral {
      background: var(--bg);
      color: var(--text-muted);
    }

    /* ====== –ö–Ω–æ–ø–∫–∏ ====== */
    .btn {
      padding: 0.625rem 1.25rem;
      border-radius: var(--radius);
      font-weight: 600;
      font-size: 0.875rem;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
      background: var(--surface);
      color: var(--primary);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg);
      border-color: var(--primary);
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    /* ====== –§–æ—Ä–º—ã ====== */
    .upload-area {
      border: 2px dashed var(--border);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
      background: var(--bg);
    }

    .upload-area:hover {
      border-color: var(--primary);
      background: var(--surface);
    }

    .upload-area.active {
      border-color: var(--primary);
      background: rgba(30, 64, 175, 0.05);
    }

    .upload-icon {
      font-size: 2.5rem;
      margin-bottom: 0.75rem;
      color: var(--text-muted);
    }

    .file-input {
      display: none;
    }

    .file-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      background: var(--success-bg);
      color: var(--success);
      border-radius: var(--radius);
      font-size: 0.75rem;
      font-weight: 600;
      margin: 0.375rem;
    }

    /* ====== –¢–∞–±–ª–∏—Ü—ã ====== */
    .table-container {
      background: var(--surface);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow);
      margin-bottom: 1rem;
    }

    .table-scroll {
      max-height: 500px;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    thead {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      padding: 0.875rem 0.75rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
    }

    th:not(:first-child) {
      text-align: right;
    }

    td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.8125rem;
    }

    td:not(:first-child) {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    tbody tr {
      transition: all 0.2s;
    }

    tbody tr:hover {
      background: var(--bg);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .table-footer {
      background: var(--bg);
      font-weight: 700;
      border-top: 2px solid var(--border);
    }

    /* ====== –ü–ª–∞–Ω-–§–∞–∫—Ç —Ç–∞–±–ª–∏—Ü–∞ ====== */
    .planfact-container {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      margin-bottom: 1rem;
      box-shadow: var(--shadow);
    }

    .planfact-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 1rem;
    }

    /* ====== –ú–∞—Ç—Ä–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ ====== */
    .status-matrix-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 1rem;
    }

    .status-matrix {
      min-width: 700px;
      font-size: 0.75rem;
    }

    .status-matrix th,
    .status-matrix td {
      padding: 0.625rem;
      white-space: nowrap;
    }

    /* ====== –ì—Ä–∞—Ñ–∏–∫–∏ ====== */
    .chart-container {
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      box-shadow: var(--shadow);
      margin-bottom: 1rem;
    }

    .chart-box {
      height: 350px;
      position: relative;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    /* ====== –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ====== */
    .alert {
      padding: 0.875rem 1.25rem;
      border-radius: var(--radius);
      margin: 1rem 0;
      display: flex;
      align-items: center;
      gap: 0.625rem;
      animation: slideIn 0.3s ease-out;
      font-size: 0.875rem;
    }

    @keyframes slideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .alert-success {
      background: var(--success-bg);
      color: var(--success);
      border-left: 3px solid var(--success);
    }

    .alert-error {
      background: var(--danger-bg);
      color: var(--danger);
      border-left: 3px solid var(--danger);
    }

    .alert-info {
      background: #eff6ff;
      color: var(--primary);
      border-left: 3px solid var(--primary);
    }

    /* ====== –õ–æ–∞–¥–µ—Ä ====== */
    .loader {
      display: inline-flex;
      align-items: center;
      gap: 0.625rem;
      padding: 0.875rem 1.25rem;
      background: var(--surface);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .spinner {
      width: 1rem;
      height: 1rem;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ====== –î–∞—à–±–æ—Ä–¥ ====== */
    .dashboard-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 2rem 1.5rem;
      border-radius: var(--radius-lg);
      margin-bottom: 1.5rem;
      position: relative;
      overflow: hidden;
    }

    .dashboard-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 50%;
      height: 200%;
      background: rgba(255, 255, 255, 0.1);
      transform: rotate(45deg);
    }

    .dashboard-title {
      font-size: 1.5rem;
      font-weight: 800;
      margin-bottom: 0.375rem;
      position: relative;
    }

    .dashboard-subtitle {
      font-size: 0.875rem;
      opacity: 0.9;
      position: relative;
    }

    .dashboard-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.75rem;
      margin-top: 1.5rem;
      position: relative;
    }

    .dashboard-stat {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      padding: 0.75rem;
      border-radius: var(--radius);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .dashboard-stat-label {
      font-size: 0.75rem;
      opacity: 0.9;
      margin-bottom: 0.25rem;
    }

    .dashboard-stat-value {
      font-size: 1.25rem;
      font-weight: 700;
    }

    /* ====== –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è ====== */
    @media (max-width: 768px) {
      .container {
        padding: 0.75rem;
      }

      .header-content {
        padding: 0.875rem;
      }

      .logo-title {
        font-size: 0.75rem;
      }

      .nav-tabs {
        padding: 0.25rem;
      }

      .nav-tab {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
      }

      .dashboard-header {
        padding: 1.5rem 1rem;
      }

      .dashboard-title {
        font-size: 1.25rem;
      }

      .dashboard-stats {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
      }

      .card {
        padding: 1rem;
      }

      .card-title {
        font-size: 1rem;
      }

      .grid-2,
      .grid-3,
      .grid-4 {
        grid-template-columns: 1fr;
      }

      .metric-value {
        font-size: 1.5rem;
      }

      .metric-icon {
        width: 2rem;
        height: 2rem;
        font-size: 1rem;
      }

      .table-scroll {
        max-height: 400px;
      }

      table {
        font-size: 0.75rem;
      }

      th, td {
        padding: 0.625rem 0.5rem;
      }

      .chart-box {
        height: 250px;
      }

      .btn {
        padding: 0.5rem 1rem;
        font-size: 0.75rem;
      }

      .upload-area {
        padding: 1rem;
      }

      .upload-icon {
        font-size: 2rem;
      }

      .status-badge {
        font-size: 0.625rem;
        padding: 0.25rem 0.5rem;
      }

      .btn-group {
        flex-direction: column;
        align-items: stretch;
      }

      .btn {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .dashboard-stats {
        grid-template-columns: 1fr;
      }

      .dashboard-stat-value {
        font-size: 1.125rem;
      }

      .metric-value {
        font-size: 1.25rem;
      }

      th {
        font-size: 0.625rem;
      }

      td {
        font-size: 0.6875rem;
      }
    }

    /* ====== –ü–µ—á–∞—Ç—å ====== */
    @media print {
      body {
        background: white;
      }

      .header, .nav-tabs, .btn-group {
        display: none;
      }

      .container {
        max-width: 100%;
        padding: 0;
      }

      .card {
        box-shadow: none;
        border: 1px solid #e5e7eb;
        page-break-inside: avoid;
      }

      .table-scroll {
        max-height: none;
        overflow: visible;
      }
    }

    /* ====== –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã ====== */
    .print-only {
      display: none;
    }
  </style>

  <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if(window.pdfjsLib){
      pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
  <!-- –®–∞–ø–∫–∞ -->
  <header class="header">
    <div class="header-content">
      <div class="logo-section">
        <div class="logo">–†–ö</div>
        <div class="logo-text">
          <div class="logo-title">–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª</div>
          <div class="logo-subtitle">–°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –í–û–õ–°</div>
        </div>
      </div>
      <div class="header-actions">
        <div class="status-badge">
          <span class="status-dot"></span>
          <span>–ê–∫—Ç–∏–≤–Ω–∞</span>
        </div>
      </div>
    </div>
  </header>

  <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
  <div class="container">
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab('dashboard', event)">
        üìä –î–∞—à–±–æ—Ä–¥
      </button>
      <button class="nav-tab" onclick="switchTab('upload', event)">
        üì§ –ó–∞–≥—Ä—É–∑–∫–∞
      </button>
      <button class="nav-tab" onclick="switchTab('analytics', event)">
        üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
      </button>
      <button class="nav-tab" onclick="switchTab('reports', event)">
        üìë –û—Ç—á–µ—Ç—ã
      </button>
    </div>

    <!-- –¢–∞–±: –î–∞—à–±–æ—Ä–¥ -->
    <div id="dashboard" class="tab-content active">
      <div class="dashboard-header">
        <div class="dashboard-title">–°–≤–æ–¥–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –í–û–õ–°</div>
        <div class="dashboard-subtitle" id="dashboardDates">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ—Ç—á–µ—Ç—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö</div>
        <div class="dashboard-stats" id="dashboardStats"></div>
      </div>

      <!-- –ü–ª–∞–Ω-–§–∞–∫—Ç -->
      <div class="planfact-container">
        <div class="planfact-title">üìä –ü–ª–∞–Ω-–§–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ë–ü</div>
        <div id="planFactDashboard"></div>
      </div>

      <!-- –ú–µ—Ç—Ä–∏–∫–∏ -->
      <div class="grid grid-4" id="metricsGrid">
        <!-- –ú–µ—Ç—Ä–∏–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
      <div class="grid grid-2">
        <div class="chart-container">
          <div class="card-header">
            <h3 class="card-title">üìä –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</h3>
          </div>
          <div class="chart-box">
            <canvas id="chartMain"></canvas>
          </div>
        </div>
        <div class="chart-container">
          <div class="card-header">
            <h3 class="card-title">üéØ –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º</h3>
          </div>
          <div class="chart-box">
            <canvas id="chartStatus"></canvas>
          </div>
        </div>
      </div>

      <!-- –¢–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤ -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">üìã –í—Å–µ —Ñ–∏–ª–∏–∞–ª—ã - –¥–∏–Ω–∞–º–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π</h3>
        </div>
        <div class="table-container">
          <div class="table-scroll">
            <table id="allBranches">
              <thead>
                <tr>
                  <th>–§–∏–ª–∏–∞–ª</th>
                  <th>–ü—Ä–µ–¥—ã–¥—É—â–∞—è</th>
                  <th>–¢–µ–∫—É—â–∞—è</th>
                  <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
                </tr>
              </thead>
              <tbody></tbody>
              <tfoot class="table-footer">
                <tr>
                  <td>–ò—Ç–æ–≥–æ</td>
                  <td id="allBranchesPrev">0</td>
                  <td id="allBranchesCurr">0</td>
                  <td id="allBranchesDelta">0</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- –ú–∞—Ç—Ä–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">üéØ –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –≤ —Ä–∞–∑—Ä–µ–∑–µ —Ñ–∏–ª–∏–∞–ª–æ–≤</h3>
        </div>
        <div class="status-matrix-container">
          <table class="status-matrix" id="statusMatrix">
            <thead>
              <tr>
                <th>–§–∏–ª–∏–∞–ª</th>
                <th>–í —Ä–∞–±–æ—Ç–µ</th>
                <th>–î–µ–º–æ–Ω—Ç.</th>
                <th>–ù–∞ –æ—Ñ–æ—Ä–º–ª.</th>
                <th>–ù–∞ –ø–æ–¥–ø–∏—Å.</th>
                <th>–ù–∞ —Å–æ–≥–ª.</th>
                <th>–°–ª–µ–¥. –î–°</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –¢–∞–±: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö -->
    <div id="upload" class="tab-content">
      <div class="grid grid-2">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìÖ –ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è</h3>
          </div>
          <label for="filePrev" class="upload-area" id="uploadPrev">
            <div class="upload-icon">üìÅ</div>
            <div>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ PDF</div>
            <input type="file" id="filePrev" class="file-input" accept="application/pdf">
          </label>
          <div id="filePrevInfo"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìÖ –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</h3>
          </div>
          <label for="fileCurr" class="upload-area" id="uploadCurr">
            <div class="upload-icon">üìÅ</div>
            <div>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ PDF</div>
            <input type="file" id="fileCurr" class="file-input" accept="application/pdf">
          </label>
          <div id="fileCurrInfo"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title">‚öôÔ∏è –î–µ–π—Å—Ç–≤–∏—è</h3>
        </div>
        <div class="btn-group">
          <button id="btnAnalyze" class="btn btn-primary">
            üöÄ –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ
          </button>
          <button id="btnClear" class="btn btn-secondary">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
          </button>
        </div>
        <div id="uploadStatus" style="margin-top: 1rem;"></div>
      </div>

      <div class="alert alert-info">
        <span>‚ÑπÔ∏è</span>
        <div>
          <strong>–°–ø—Ä–∞–≤–∫–∞:</strong> –ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF-–æ—Ç—á–µ—Ç—ã –∑–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –∏ —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª–∏.
          –ü–æ–∫–∞–∑–∞—Ç–µ–ª—å ¬´–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é¬ª = —Ä–∞–∑–Ω–∏—Ü–∞ ¬´–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ¬ª.
        </div>
      </div>
    </div>

    <!-- –¢–∞–±: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
    <div id="analytics" class="tab-content">
      <!-- –ü–ª–∞–Ω-–§–∞–∫—Ç -->
      <div class="planfact-container">
        <div class="planfact-title">üìä –ü–ª–∞–Ω-–§–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ë–ü</div>
        <div id="planFactAnalytics"></div>
      </div>

      <div class="grid grid-3">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìä –û–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblGeneral">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥.</th>
                    <th>–¢–µ–∫.</th>
                    <th>Œî</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot class="table-footer">
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="totalPrev">0</td>
                    <td id="totalCurr">0</td>
                    <td id="totalDelta">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìã –ü—Ä–∏–∫–∞–∑ ‚Ññ425</h3>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tbl425">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥.</th>
                    <th>–¢–µ–∫.</th>
                    <th>Œî</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot class="table-footer">
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="total425Prev">0</td>
                    <td id="total425Curr">0</td>
                    <td id="total425Delta">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìû –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h3>
          </div>
          <div class="table-container">
            <div class="table-scroll">
              <table id="tblRTK">
                <thead>
                  <tr>
                    <th>–§–∏–ª–∏–∞–ª</th>
                    <th>–ü—Ä–µ–¥.</th>
                    <th>–¢–µ–∫.</th>
                    <th>Œî</th>
                  </tr>
                </thead>
                <tbody></tbody>
                <tfoot class="table-footer">
                  <tr>
                    <td>–ò—Ç–æ–≥–æ</td>
                    <td id="totalRTKPrev">0</td>
                    <td id="totalRTKCurr">0</td>
                    <td id="totalRTKDelta">0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
      <div class="grid grid-2">
        <div class="chart-container">
          <div class="card-header">
            <h3 class="card-title">üìà –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425</h3>
          </div>
          <div class="chart-box">
            <canvas id="chart425"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <div class="card-header">
            <h3 class="card-title">üìà –î–∏–Ω–∞–º–∏–∫–∞ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h3>
          </div>
          <div class="chart-box">
            <canvas id="chartRTK"></canvas>
          </div>
        </div>
      </div>

      <!-- –°—Ç–∞—Ç—É—Å—ã -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">üéØ –°—Ç–∞—Ç—É—Å—ã —Ä–∞–±–æ—Ç - –≤—Å–µ —Ñ–∏–ª–∏–∞–ª—ã</h3>
        </div>
        <div class="status-matrix-container">
          <table class="status-matrix" id="statusMatrixAnalytics">
            <thead>
              <tr>
                <th>–§–∏–ª–∏–∞–ª</th>
                <th>–í —Ä–∞–±–æ—Ç–µ</th>
                <th>–î–µ–º–æ–Ω—Ç.</th>
                <th>–ù–∞ –æ—Ñ–æ—Ä–º–ª.</th>
                <th>–ù–∞ –ø–æ–¥–ø–∏—Å.</th>
                <th>–ù–∞ —Å–æ–≥–ª.</th>
                <th>–°–ª–µ–¥. –î–°</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- –¢–∞–±: –û—Ç—á–µ—Ç—ã -->
    <div id="reports" class="tab-content">
      <div class="grid grid-2">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìë –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞</h3>
          </div>
          <p class="card-subtitle">–í–∏–∑—É–∞–ª—å–Ω–∞—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å–æ –≤—Å–µ–º–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏</p>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="exportExecutive()">
              üìä –°–∫–∞—á–∞—Ç—å
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìã –ü–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç</h3>
          </div>
          <p class="card-subtitle">–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç —Å–æ –≤—Å–µ–º–∏ –¥–∞–Ω–Ω—ã–º–∏</p>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="exportDetailed()">
              üìÑ –°–∫–∞—á–∞—Ç—å
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìà –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∞—à–±–æ—Ä–¥</h3>
          </div>
          <p class="card-subtitle">HTML –≤–µ—Ä—Å–∏—è –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞</p>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="exportDashboard()">
              üåê –°–∫–∞—á–∞—Ç—å
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">üìù –û—Ç—á–µ—Ç –¥–ª—è Word</h3>
          </div>
          <p class="card-subtitle">–î–æ–∫—É–º–µ–Ω—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
          <div class="btn-group">
            <button class="btn btn-primary" onclick="exportWord()">
              üìù –°–∫–∞—á–∞—Ç—å
            </button>
          </div>
        </div>
      </div>

      <div class="alert alert-info">
        <span>‚ÑπÔ∏è</span>
        <div>
          –í—Å–µ –æ—Ç—á–µ—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º —Ñ–∏–ª–∏–∞–ª–∞–º, –ø–ª–∞–Ω-—Ñ–∞–∫—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏ –¥–∏–Ω–∞–º–∏–∫—É –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
        </div>
      </div>
    </div>
  </div>

  <script>
    // ==================== –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ====================
    let DATA = null;
    let charts = {};

    // ==================== –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã ====================
    const BRANCHES = [
      "–°–æ—á–∏–Ω—Å–∫–∏–µ –≠–°", "–¢–∏–º–∞—à–µ–≤—Å–∫–∏–µ –≠–°", "–¢–∏—Ö–æ—Ä–µ—Ü–∫–∏–µ –≠–°", "–£—Å—Ç—å-–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°", "–Æ–≥–æ-–ó–∞–ø–∞–¥–Ω—ã–µ –≠–°",
      "–ê–¥—ã–≥–µ–π—Å–∫–∏–µ –≠–°", "–ê—Ä–º–∞–≤–∏—Ä—Å–∫–∏–µ –≠–°", "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–µ –≠–°", "–õ–∞–±–∏–Ω—Å–∫–∏–µ –≠–°", "–õ–µ–Ω–∏–Ω–≥—Ä–∞–¥—Å–∫–∏–µ –≠–°", "–°–ª–∞–≤—è–Ω—Å–∫–∏–µ –≠–°"
    ];

    const BRANCH_PATTERNS = BRANCHES.map(name => ({
      name,
      re: new RegExp(name.replace(/[\s-]/g, '[\\s\\-]*'), 'i')
    }));

    const STATUS_PATTERNS = [
      {key: "work", title: "–í —Ä–∞–±–æ—Ç–µ —É —Ñ–∏–ª–∏–∞–ª–∞", short: "–í —Ä–∞–±–æ—Ç–µ", re: /–í\s*—Ä–∞–±–æ—Ç–µ\s*—É\s*—Ñ–∏–ª–∏–∞–ª–∞/i},
      {key: "dismantled", title: "–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ", short: "–î–µ–º–æ–Ω—Ç.", re: /–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ/i},
      {key: "rc_digit", title: "–î–æ–≥–æ–≤–æ—Ä –Ω–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏", short: "–ù–∞ –æ—Ñ–æ—Ä–º–ª.", re: /–î–æ–≥–æ–≤–æ—Ä\s*–Ω–∞\s*–æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏/i},
      {key: "op_sign", title: "–ù–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏", short: "–ù–∞ –ø–æ–¥–ø–∏—Å.", re: /–Ω–∞\s*–ø–æ–¥–ø–∏—Å–∞–Ω–∏–∏/i},
      {key: "filial_appr", title: "–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏", short: "–ù–∞ —Å–æ–≥–ª.", re: /–Ω–∞\s*—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏/i},
      {key: "incl_next", title: "–í —Å–ª–µ–¥—É—é—â–µ–º –î–°", short: "–°–ª–µ–¥. –î–°", re: /—Å–ª–µ–¥—É—é—â/i}
    ];

    // Google Sheets URL –¥–ª—è –ü–ª–∞–Ω-–§–∞–∫—Ç
    const SHEET_HTML_URL = "https://docs.google.com/spreadsheets/d/1Y9bM7zLRf_gonMUgfQLl57Iu3NgPa78rBXnpxkKLvO0/gviz/tq?tqx=out:html";

    // ==================== –£—Ç–∏–ª–∏—Ç—ã ====================
    const numberize = s => {
      const cleaned = String(s || "").replace(/[^\d\-.,]/g, "").replace(/\s+/g, "");
      return Number(cleaned.replace(",", ".")) || 0;
    };

    const fmt = n => (typeof n === "number" ? n : Number(n || 0)).toLocaleString("ru-RU");

    const normalize = txt => String(txt || "")
      .replace(/\u00A0|\u202F/g, " ")
      .replace(/\u00AD/g, "")
      .replace(/[ \t]+/g, " ")
      .trim();

    // ==================== –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤ ====================
    function switchTab(tabName, event) {
      document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
    }

    // ==================== –ü–ª–∞–Ω-–§–∞–∫—Ç –∏–∑ Google Sheets ====================
    async function loadPlanFact() {
      try {
        const res = await fetch(SHEET_HTML_URL, {cache: "no-store", mode: "cors"});
        if (!res.ok) throw new Error("HTTP " + res.status);
        
        const html = await res.text();
        const tmp = document.createElement("div");
        tmp.innerHTML = html;
        const table = tmp.querySelector("table");
        
        if (!table) throw new Error("–¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");

        // –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã
        table.style.cssText = "width:100%;border-collapse:collapse;font-size:0.8125rem;";
        table.querySelectorAll("th").forEach(th => {
          th.style.cssText = "background:var(--primary);padding:0.75rem;font-weight:600;color:white;text-align:center;border:1px solid var(--primary-dark);";
        });
        table.querySelectorAll("td").forEach(td => {
          td.style.cssText = "padding:0.625rem;text-align:center;border:1px solid var(--border);color:var(--text);";
        });
        table.querySelectorAll("tr").forEach((tr, i) => {
          if (i > 0 && i % 2 === 0) tr.style.background = "var(--bg)";
        });

        // –í—Å—Ç–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
        document.getElementById("planFactDashboard").innerHTML = table.outerHTML;
        document.getElementById("planFactAnalytics").innerHTML = table.cloneNode(true).outerHTML;
        
        return table.outerHTML;
      } catch (e) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ü–ª–∞–Ω-–§–∞–∫—Ç:", e);
        const fallback = `<div class="alert alert-info">‚ö†Ô∏è –ü–ª–∞–Ω-–§–∞–∫—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. <a href="${SHEET_HTML_URL}" target="_blank">–û—Ç–∫—Ä—ã—Ç—å —Ç–∞–±–ª–∏—Ü—É</a></div>`;
        document.getElementById("planFactDashboard").innerHTML = fallback;
        document.getElementById("planFactAnalytics").innerHTML = fallback;
        return fallback;
      }
    }

    // ==================== –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ ====================
    document.getElementById('filePrev').addEventListener('change', function(e) {
      handleFileSelect(e, 'prev');
    });

    document.getElementById('fileCurr').addEventListener('change', function(e) {
      handleFileSelect(e, 'curr');
    });

    function handleFileSelect(e, type) {
      const file = e.target.files[0];
      if (file) {
        const infoEl = document.getElementById(`file${type === 'prev' ? 'Prev' : 'Curr'}Info`);
        infoEl.innerHTML = `<div class="file-badge">‚úÖ ${file.name}</div>`;
        
        const uploadArea = document.getElementById(`upload${type === 'prev' ? 'Prev' : 'Curr'}`);
        uploadArea.classList.add('active');
      }
    }

    // ==================== –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö ====================
    document.getElementById('btnAnalyze').addEventListener('click', async () => {
      const filePrev = document.getElementById('filePrev').files[0];
      const fileCurr = document.getElementById('fileCurr').files[0];
      
      if (!filePrev || !fileCurr) {
        showMessage('–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ —Ñ–∞–π–ª–∞', 'error');
        return;
      }

      showMessage('–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö...', 'loading');

      try {
        const [pagesPrev, pagesCurr] = await Promise.all([
          pdfToPages(filePrev),
          pdfToPages(fileCurr)
        ]);

        const prev = parseReportByPages(pagesPrev);
        const curr = parseReportByPages(pagesCurr);
        const dyn = computeDynamics(curr, prev);

        DATA = { prev, curr, dyn };

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–∞–Ω-—Ñ–∞–∫—Ç
        await loadPlanFact();

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
        updateDashboard();
        updateAnalytics();
        showMessage('–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');

        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –¥–∞—à–±–æ—Ä–¥
        document.querySelector('.nav-tab').click();
      } catch (error) {
        console.error(error);
        showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ñ–∞–π–ª–æ–≤', 'error');
      }
    });

    document.getElementById('btnClear').addEventListener('click', () => {
      document.getElementById('filePrev').value = '';
      document.getElementById('fileCurr').value = '';
      document.getElementById('filePrevInfo').innerHTML = '';
      document.getElementById('fileCurrInfo').innerHTML = '';
      document.getElementById('uploadPrev').classList.remove('active');
      document.getElementById('uploadCurr').classList.remove('active');
      DATA = null;
      showMessage('–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', 'success');
    });

    // ==================== PDF –æ–±—Ä–∞–±–æ—Ç–∫–∞ ====================
    async function pdfToPages(file) {
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      const pages = [];
      
      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        let pageText = "", lastY = null;
        
        content.items.forEach(item => {
          const y = item.transform[5];
          if (lastY !== null && Math.abs(y - lastY) > 5) pageText += "\n";
          pageText += item.str;
          lastY = y;
        });
        
        pages.push(normalize(pageText));
      }
      
      return pages;
    }

    // ==================== –ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö ====================
    function parseReportByPages(pages) {
      return {
        date: extractDateFromPages(pages),
        p1: { totals: parseTotalsFromPage(pages[0] || "") },
        p2: parseBranchTable(pages[1] || ""),
        p3: parseBranchTable(pages[2] || ""),
        p4: parseBranchTable(pages[3] || "")
      };
    }

    function extractDateFromPages(pages) {
      for (const pg of pages) {
        const m = pg.match(/–ø–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é –Ω–∞\s+(\d{2}\.\d{2}\.\d{4})/i);
        if (m) return m[1];
      }
      return "‚Äî";
    }

    function parseTotalsFromPage(page) {
      const find = (re) => {
        const m = page.match(re);
        return m ? numberize(m[1]) : 0;
      };
      
      return {
        found_year: find(/–≤—ã—è–≤–ª–µ–Ω–æ[^0-9]*?(\d[\d\s]+)\s*—à—Ç/i),
        legalized: find(/–£–∑–∞–∫–æ–Ω–µ–Ω–æ[^0-9]*?(\d[\d\s]+)/i),
        dismantled_ytd: find(/–¥–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ[^0-9]*?(\d[\d\s]+)/i),
        in_work_total: find(/–í\s*—Ä–∞–±–æ—Ç–µ[^0-9]*?–≤—Å–µ–≥–æ[^0-9]*?(\d[\d\s]+)\s*—à—Ç/i),
        rtk_in_work: find(/–†–æ—Å—Ç–µ–ª–µ–∫–æ–º[^0-9]*?(\d[\d\s]+)/i)
      };
    }

    function parseBranchTable(pageText) {
      const branches = new Map();
      const lines = pageText.split("\n").filter(Boolean);
      
      // –ü–∞—Ä—Å–∏–Ω–≥ —Å —É—á–µ—Ç–æ–º —Å—Ç–∞—Ç—É—Å–æ–≤
      for (const branch of BRANCHES) {
        const pattern = BRANCH_PATTERNS.find(p => p.name === branch);
        let total = 0;
        const statuses = {};
        
        // –ò—â–µ–º —Ñ–∏–ª–∏–∞–ª –∏ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ
        for (let i = 0; i < lines.length; i++) {
          if (pattern.re.test(lines[i])) {
            // –û—Å–Ω–æ–≤–Ω–æ–µ —á–∏—Å–ª–æ
            const nums = lines[i].match(/\d+/g);
            if (nums && nums.length) {
              total = numberize(nums[nums.length - 1]);
            }
            
            // –ò—â–µ–º —Å—Ç–∞—Ç—É—Å—ã –≤ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —Å—Ç—Ä–æ–∫–∞—Ö
            for (let j = i + 1; j < Math.min(i + 10, lines.length); j++) {
              for (const sp of STATUS_PATTERNS) {
                if (sp.re.test(lines[j])) {
                  const statusNums = lines[j].match(/\d+/g);
                  if (statusNums && statusNums.length) {
                    statuses[sp.key] = numberize(statusNums[statusNums.length - 1]);
                  }
                }
              }
            }
            break;
          }
        }
        
        branches.set(branch, { total, statuses });
      }
      
      const overall = [...branches.values()].reduce((s, r) => s + r.total, 0);
      
      // –°—É–º–º–∞—Ä–Ω—ã–µ —Å—Ç–∞—Ç—É—Å—ã
      const stages = {};
      for (const [_, data] of branches) {
        for (const [key, value] of Object.entries(data.statuses)) {
          stages[key] = (stages[key] || 0) + value;
        }
      }
      
      return { branches, overall, stages };
    }

    function computeDynamics(curr, prev) {
      const dyn = {
        in_work_total: curr.p1.totals.in_work_total - prev.p1.totals.in_work_total,
        rtk_in_work: curr.p1.totals.rtk_in_work - prev.p1.totals.rtk_in_work,
        legalized: curr.p1.totals.legalized - prev.p1.totals.legalized,
        dismantled_ytd: curr.p1.totals.dismantled_ytd - prev.p1.totals.dismantled_ytd
      };
      
      dyn.found_week = dyn.in_work_total;
      
      const makeRows = (cPage, pPage) => BRANCHES.map(b => ({
        b,
        p: pPage.branches.get(b)?.total || 0,
        c: cPage.branches.get(b)?.total || 0,
        d: (cPage.branches.get(b)?.total || 0) - (pPage.branches.get(b)?.total || 0)
      }));
      
      // –°—Ç–∞—Ç—É—Å—ã –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º
      const makeStatusRows = (cPage, pPage) => BRANCHES.map(b => {
        const row = { b, statuses: {} };
        for (const sp of STATUS_PATTERNS) {
          const prev = pPage.branches.get(b)?.statuses[sp.key] || 0;
          const curr = cPage.branches.get(b)?.statuses[sp.key] || 0;
          row.statuses[sp.key] = { p: prev, c: curr, d: curr - prev };
        }
        return row;
      });
      
      return {
        ...dyn,
        branchRows: makeRows(curr.p2, prev.p2),
        branchRowsS3: makeRows(curr.p3, prev.p3),
        branchRowsS4: makeRows(curr.p4, prev.p4),
        statusRows: makeStatusRows(curr.p2, prev.p2),
        stagesS2: STATUS_PATTERNS.map(sp => ({
          key: sp.key,
          title: sp.title,
          short: sp.short,
          p: prev.p2.stages[sp.key] || 0,
          c: curr.p2.stages[sp.key] || 0,
          d: (curr.p2.stages[sp.key] || 0) - (prev.p2.stages[sp.key] || 0)
        }))
      };
    }

    // ==================== –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ====================
    function updateDashboard() {
      if (!DATA) return;
      
      const { curr, prev, dyn } = DATA;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—ã
      document.getElementById('dashboardDates').textContent = 
        `–ü–µ—Ä–∏–æ–¥: ${prev.date} ‚Äî ${curr.date}`;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ —à–∞–ø–∫–µ
      const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - 
                  (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
      const rtkShare = curr.p1.totals.in_work_total ? 
        (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;
      
      document.getElementById('dashboardStats').innerHTML = `
        <div class="dashboard-stat">
          <div class="dashboard-stat-label">–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ</div>
          <div class="dashboard-stat-value">${fmt(curr.p1.totals.in_work_total)}</div>
        </div>
        <div class="dashboard-stat">
          <div class="dashboard-stat-label">–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
          <div class="dashboard-stat-value">${fmt(dyn.found_week)}</div>
        </div>
        <div class="dashboard-stat">
          <div class="dashboard-stat-label">–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
          <div class="dashboard-stat-value">${fmt(eff)}</div>
        </div>
        <div class="dashboard-stat">
          <div class="dashboard-stat-label">–î–æ–ª—è –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</div>
          <div class="dashboard-stat-value">${rtkShare.toFixed(1)}%</div>
        </div>
      `;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
      const metrics = [
        {
          icon: 'üìä',
          label: '–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ',
          value: curr.p1.totals.in_work_total,
          change: dyn.in_work_total
        },
        {
          icon: 'üîç',
          label: '–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é',
          value: dyn.found_week,
          change: dyn.found_week
        },
        {
          icon: '‚úÖ',
          label: '–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é',
          value: eff,
          change: eff
        },
        {
          icon: 'üìû',
          label: '–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª',
          value: curr.p1.totals.rtk_in_work,
          change: dyn.rtk_in_work
        }
      ];
      
      document.getElementById('metricsGrid').innerHTML = metrics.map(m => `
        <div class="metric-card">
          <div class="metric-icon">${m.icon}</div>
          <div class="metric-label">${m.label}</div>
          <div class="metric-value">${fmt(m.value)}</div>
          <div class="metric-change ${m.change > 0 ? 'positive' : m.change < 0 ? 'negative' : 'neutral'}">
            ${m.change > 0 ? '‚Üë' : m.change < 0 ? '‚Üì' : '‚Üí'} ${m.change > 0 ? '+' : ''}${fmt(m.change)}
          </div>
        </div>
      `).join('');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –≤—Å–µ—Ö —Ñ–∏–ª–∏–∞–ª–æ–≤
      fillTable('allBranches', dyn.branchRows, 'allBranchesPrev', 'allBranchesCurr', 'allBranchesDelta');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ç—Ä–∏—Ü—É —Å—Ç–∞—Ç—É—Å–æ–≤
      fillStatusMatrix('statusMatrix', dyn.statusRows);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫–∏
      updateCharts();
    }

    function updateAnalytics() {
      if (!DATA) return;
      
      const { dyn } = DATA;
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—ã
      fillTable('tblGeneral', dyn.branchRows, 'totalPrev', 'totalCurr', 'totalDelta');
      fillTable('tbl425', dyn.branchRowsS3, 'total425Prev', 'total425Curr', 'total425Delta');
      fillTable('tblRTK', dyn.branchRowsS4, 'totalRTKPrev', 'totalRTKCurr', 'totalRTKDelta');
      
      // –ú–∞—Ç—Ä–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
      fillStatusMatrix('statusMatrixAnalytics', dyn.statusRows);
    }

    function fillTable(tableId, rows, prevId, currId, deltaId) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      let sumPrev = 0, sumCurr = 0, sumDelta = 0;
      
      tbody.innerHTML = rows.map(row => {
        sumPrev += row.p;
        sumCurr += row.c;
        sumDelta += row.d;
        
        return `
          <tr>
            <td style="font-weight: 600;">${row.b}</td>
            <td>${fmt(row.p)}</td>
            <td>${fmt(row.c)}</td>
            <td style="color: ${row.d > 0 ? 'var(--success)' : row.d < 0 ? 'var(--danger)' : 'var(--text-muted)'}; font-weight: 700;">
              ${row.d > 0 ? '+' : ''}${fmt(row.d)}
            </td>
          </tr>
        `;
      }).join('');
      
      document.getElementById(prevId).textContent = fmt(sumPrev);
      document.getElementById(currId).textContent = fmt(sumCurr);
      document.getElementById(deltaId).textContent = (sumDelta > 0 ? '+' : '') + fmt(sumDelta);
    }

    function fillStatusMatrix(tableId, rows) {
      const tbody = document.querySelector(`#${tableId} tbody`);
      
      tbody.innerHTML = rows.map(row => {
        const cells = STATUS_PATTERNS.map(sp => {
          const data = row.statuses[sp.key];
          if (!data) return '<td>‚Äî</td>';
          
          const d = data.d || 0;
          const color = d > 0 ? 'var(--success)' : d < 0 ? 'var(--danger)' : 'var(--text-muted)';
          return `<td style="color: ${color}; font-weight: 600;">${d > 0 ? '+' : ''}${fmt(d)}</td>`;
        }).join('');
        
        return `<tr><td style="font-weight: 600;">${row.b}</td>${cells}</tr>`;
      }).join('');
    }

    // ==================== –ì—Ä–∞—Ñ–∏–∫–∏ ====================
    function updateCharts() {
      if (!DATA) return;
      
      const { curr, prev, dyn } = DATA;
      const labels = BRANCHES;
      
      // –ì—Ä–∞—Ñ–∏–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –¥–∏–Ω–∞–º–∏–∫–∏
      if (charts.main) charts.main.destroy();
      charts.main = new Chart(document.getElementById('chartMain'), {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: '–ü—Ä–µ–¥—ã–¥—É—â–∞—è',
              data: labels.map(b => prev.p2.branches.get(b)?.total || 0),
              backgroundColor: 'rgba(148, 163, 184, 0.8)',
              borderColor: 'rgba(148, 163, 184, 1)',
              borderWidth: 1
            },
            {
              label: '–¢–µ–∫—É—â–∞—è',
              data: labels.map(b => curr.p2.branches.get(b)?.total || 0),
              backgroundColor: 'rgba(30, 64, 175, 0.8)',
              borderColor: 'rgba(30, 64, 175, 1)',
              borderWidth: 1
            }
          ]
        },
        options: getChartOptions()
      });
      
      // –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
      if (charts.status) charts.status.destroy();
      charts.status = new Chart(document.getElementById('chartStatus'), {
        type: 'doughnut',
        data: {
          labels: STATUS_PATTERNS.map(sp => sp.short),
          datasets: [{
            data: STATUS_PATTERNS.map(sp => curr.p2.stages[sp.key] || 0),
            backgroundColor: [
              'rgba(30, 64, 175, 0.8)',
              'rgba(239, 68, 68, 0.8)',
              'rgba(245, 158, 11, 0.8)',
              'rgba(16, 185, 129, 0.8)',
              'rgba(6, 182, 212, 0.8)',
              'rgba(139, 92, 246, 0.8)'
            ]
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 10,
                font: { size: 11 }
              }
            }
          }
        }
      });
      
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
      if (document.getElementById('chart425')) {
        if (charts.chart425) charts.chart425.destroy();
        charts.chart425 = new Chart(document.getElementById('chart425'), {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                label: '–ò–∑–º–µ–Ω–µ–Ω–∏–µ',
                data: dyn.branchRowsS3.map(r => r.d),
                borderColor: 'rgba(6, 182, 212, 1)',
                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                tension: 0.4
              }
            ]
          },
          options: getChartOptions()
        });
      }
      
      if (document.getElementById('chartRTK')) {
        if (charts.chartRTK) charts.chartRTK.destroy();
        charts.chartRTK = new Chart(document.getElementById('chartRTK'), {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Œî –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª',
              data: dyn.branchRowsS4.map(r => r.d),
              backgroundColor: dyn.branchRowsS4.map(r => 
                r.d > 0 ? 'rgba(16, 185, 129, 0.8)' : 'rgba(239, 68, 68, 0.8)'
              )
            }]
          },
          options: getChartOptions()
        });
      }
    }

    function getChartOptions() {
      return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              padding: 10,
              font: {
                size: 11
              }
            }
          },
          tooltip: {
            backgroundColor: 'rgba(30, 41, 59, 0.95)',
            padding: 10,
            cornerRadius: 8,
            titleFont: {
              size: 12,
              weight: 'bold'
            },
            bodyFont: {
              size: 11
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0, 0, 0, 0.05)'
            },
            ticks: {
              font: { size: 10 }
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
              font: { size: 10 }
            }
          }
        }
      };
    }

    // ==================== –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–æ–≤ ====================
    async function exportExecutive() {
      if (!DATA) {
        showMessage('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ', 'error');
        return;
      }
      
      const planFactHTML = await loadPlanFact();
      const { curr, prev, dyn } = DATA;
      const html = generateExecutiveReport(curr, prev, dyn, planFactHTML);
      downloadHTML(html, `–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è_–í–û–õ–°_${curr.date.replace(/\./g, '-')}.html`);
      showMessage('–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
    }

    async function exportDetailed() {
      if (!DATA) {
        showMessage('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ', 'error');
        return;
      }
      
      const planFactHTML = await loadPlanFact();
      const { curr, prev, dyn } = DATA;
      const html = generateDetailedReport(curr, prev, dyn, planFactHTML);
      downloadHTML(html, `–û—Ç—á–µ—Ç_–í–û–õ–°_${curr.date.replace(/\./g, '-')}.html`);
      showMessage('–û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
    }

    async function exportDashboard() {
      if (!DATA) {
        showMessage('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ', 'error');
        return;
      }
      
      const planFactHTML = await loadPlanFact();
      const { curr, prev, dyn } = DATA;
      const html = generateDashboardHTML(curr, prev, dyn, planFactHTML);
      downloadHTML(html, `–î–∞—à–±–æ—Ä–¥_–í–û–õ–°_${curr.date.replace(/\./g, '-')}.html`);
      showMessage('–î–∞—à–±–æ—Ä–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
    }

    async function exportWord() {
      if (!DATA) {
        showMessage('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ', 'error');
        return;
      }
      
      const planFactHTML = await loadPlanFact();
      const { curr, prev, dyn } = DATA;
      const html = generateWordReport(curr, prev, dyn, planFactHTML);
      downloadHTML(html, `–û—Ç—á–µ—Ç_–í–û–õ–°_Word_${curr.date.replace(/\./g, '-')}.html`);
      showMessage('–î–æ–∫—É–º–µ–Ω—Ç –¥–ª—è Word —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
    }

    // ==================== –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á–µ—Ç–æ–≤ ====================
    function generateExecutiveReport(curr, prev, dyn, planFactHTML) {
      const eff = (curr.p1.totals.legalized + curr.p1.totals.dismantled_ytd) - 
                  (prev.p1.totals.legalized + prev.p1.totals.dismantled_ytd);
      const rtkShare = curr.p1.totals.in_work_total ? 
        (curr.p1.totals.rtk_in_work / curr.p1.totals.in_work_total * 100) : 0;

      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ñ–∏–ª–∏–∞–ª–æ–≤ –æ—Ç –ê –¥–æ –Ø
      const sortedBranches = [...BRANCHES].sort((a, b) => a.localeCompare(b, 'ru'));
      
      // –°–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      const sortedBranchRows = sortedBranches.map(b => 
        dyn.branchRows.find(r => r.b === b) || {b, p: 0, c: 0, d: 0}
      );
      const sortedBranchRowsS3 = sortedBranches.map(b => 
        dyn.branchRowsS3.find(r => r.b === b) || {b, p: 0, c: 0, d: 0}
      );
      const sortedBranchRowsS4 = sortedBranches.map(b => 
        dyn.branchRowsS4.find(r => r.b === b) || {b, p: 0, c: 0, d: 0}
      );
      const sortedStatusRows = sortedBranches.map(b => 
        dyn.statusRows.find(r => r.b === b) || {b, statuses: {}}
      );

      // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –∫–∞–∫ base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
      const generateChartImage = (type, labels, datasets, options = {}) => {
        const canvas = document.createElement('canvas');
        canvas.width = 600;
        canvas.height = 400;
        const ctx = canvas.getContext('2d');
        
        new Chart(ctx, {
          type: type,
          data: { labels, datasets },
          options: {
            responsive: false,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                position: 'bottom',
                labels: {
                  font: { size: 10 },
                  padding: 10
                }
              },
              title: options.title ? {
                display: true,
                text: options.title,
                font: { size: 14, weight: 'bold' }
              } : undefined
            },
            scales: type !== 'doughnut' && type !== 'pie' ? {
              y: { 
                beginAtZero: true,
                ticks: { font: { size: 10 } }
              },
              x: {
                ticks: { font: { size: 9 }, maxRotation: 45, minRotation: 45 }
              }
            } : undefined
          }
        });
        
        return canvas.toDataURL('image/png');
      };

      // –°–æ–∑–¥–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
      const chartMainImg = generateChartImage('bar', sortedBranches, [
        {
          label: '–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è',
          data: sortedBranchRows.map(r => r.p),
          backgroundColor: 'rgba(148, 163, 184, 0.8)',
          borderColor: 'rgba(148, 163, 184, 1)',
          borderWidth: 1
        },
        {
          label: '–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è',
          data: sortedBranchRows.map(r => r.c),
          backgroundColor: 'rgba(30, 64, 175, 0.8)',
          borderColor: 'rgba(30, 64, 175, 1)',
          borderWidth: 1
        }
      ]);

      const chart425Img = generateChartImage('bar', sortedBranches, [
        {
          label: '–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è',
          data: sortedBranchRowsS3.map(r => r.p),
          backgroundColor: 'rgba(148, 163, 184, 0.8)',
          borderColor: 'rgba(148, 163, 184, 1)',
          borderWidth: 1
        },
        {
          label: '–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è',
          data: sortedBranchRowsS3.map(r => r.c),
          backgroundColor: 'rgba(30, 64, 175, 0.8)',
          borderColor: 'rgba(30, 64, 175, 1)',
          borderWidth: 1
        }
      ]);

      const chartRTKImg = generateChartImage('bar', sortedBranches, [
        {
          label: '–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è',
          data: sortedBranchRowsS4.map(r => r.p),
          backgroundColor: 'rgba(148, 163, 184, 0.8)',
          borderColor: 'rgba(148, 163, 184, 1)',
          borderWidth: 1
        },
        {
          label: '–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è',
          data: sortedBranchRowsS4.map(r => r.c),
          backgroundColor: 'rgba(30, 64, 175, 0.8)',
          borderColor: 'rgba(30, 64, 175, 1)',
          borderWidth: 1
        }
      ]);

      // –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –≤—Å–µ–≥–æ
      const statusTotalImg = generateChartImage('bar', 
        STATUS_PATTERNS.map(sp => sp.short),
        [{
          label: '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ –Ω–µ–¥–µ–ª—é',
          data: STATUS_PATTERNS.map(sp => {
            return sortedStatusRows.reduce((sum, row) => 
              sum + (row.statuses[sp.key]?.d || 0), 0
            );
          }),
          backgroundColor: STATUS_PATTERNS.map(sp => {
            const total = sortedStatusRows.reduce((sum, row) => 
              sum + (row.statuses[sp.key]?.d || 0), 0
            );
            return total > 0 ? 'rgba(16, 185, 129, 0.8)' : 
                   total < 0 ? 'rgba(239, 68, 68, 0.8)' : 
                   'rgba(148, 163, 184, 0.8)';
          }),
          borderWidth: 1
        }],
        { title: '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –∑–∞ –Ω–µ–¥–µ–ª—é' }
      );
      
      return `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞ - –ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: 'Inter', sans-serif; 
      background: #1e293b; 
      color: #1e293b;
      padding: 20px;
    }
    .slide {
      width: 100%;
      max-width: 1280px;
      min-height: 720px;
      margin: 0 auto 30px;
      background: white;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
      padding: 40px;
      position: relative;
      page-break-after: always;
      page-break-inside: avoid;
    }
    .slide-header {
      background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
      color: white;
      margin: -40px -40px 30px;
      padding: 25px 40px;
      position: relative;
    }
    h1 { 
      font-size: 1.75rem; 
      font-weight: 800; 
      margin-bottom: 5px; 
    }
    h2 { 
      font-size: 1.25rem; 
      font-weight: 700; 
      color: #1e40af; 
      margin: 20px 0 15px; 
    }
    .subtitle { 
      font-size: 0.875rem; 
      opacity: 0.9; 
    }
    .content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      align-items: start;
    }
    .chart-container {
      background: #f8fafc;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .chart-container img {
      width: 100%;
      height: auto;
      max-height: 400px;
      object-fit: contain;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8125rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }
    th {
      background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
      color: white;
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }
    th:not(:first-child), td:not(:first-child) {
      text-align: right;
    }
    tr:nth-child(even) { 
      background: #f8fafc; 
    }
    tbody tr:last-child td { 
      border-bottom: none; 
    }
    tfoot tr {
      background: #1e293b !important;
      color: white;
      font-weight: 700;
    }
    tfoot td { 
      border-bottom: none;
      border-top: 2px solid #1e40af;
    }
    .positive { color: #10b981; }
    .negative { color: #ef4444; }
    .neutral { color: #64748b; }
    .page-number {
      position: absolute;
      bottom: 20px;
      right: 30px;
      background: #1e40af;
      color: white;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.875rem;
    }
    .date-info {
      position: absolute;
      bottom: 20px;
      left: 30px;
      color: #64748b;
      font-size: 0.75rem;
    }
    .status-matrix {
      font-size: 0.75rem;
    }
    .status-matrix th {
      font-size: 0.7rem;
      padding: 8px 6px;
    }
    .status-matrix td {
      padding: 8px 6px;
      text-align: center;
    }
    .summary-box {
      background: #f8fafc;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .metric-item {
      background: white;
      padding: 15px;
      border-radius: 8px;
      border-left: 3px solid #1e40af;
    }
    .metric-label {
      font-size: 0.75rem;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 5px;
    }
    .metric-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1e293b;
    }
    @media print {
      body { 
        background: white; 
        padding: 0; 
      }
      .slide { 
        box-shadow: none; 
        margin-bottom: 0;
        border: 1px solid #e2e8f0; 
      }
    }
    @media (max-width: 768px) {
      .slide { 
        padding: 20px; 
      }
      .content-grid {
        grid-template-columns: 1fr;
      }
      h1 { 
        font-size: 1.25rem; 
      }
      table { 
        font-size: 0.7rem; 
      }
      th, td { 
        padding: 6px 8px; 
      }
    }
  </style>
</head>
<body>
  <!-- –°–ª–∞–π–¥ 1: –ü–ª–∞–Ω-–§–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π -->
  <div class="slide">
    <div class="slide-header">
      <h1>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ë–ü</h1>
      <div class="subtitle">–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª ‚Ä¢ –ü–µ—Ä–∏–æ–¥: ${prev.date} ‚Äî ${curr.date}</div>
    </div>
    <div style="margin-top: 30px;">
      ${planFactHTML}
    </div>
    <div class="summary-box">
      <div class="metrics-grid">
        <div class="metric-item">
          <div class="metric-label">–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ</div>
          <div class="metric-value">${fmt(curr.p1.totals.in_work_total)}</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">–í—ã—è–≤–ª–µ–Ω–æ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
          <div class="metric-value">${fmt(dyn.found_week)}</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">–ó–∞–∫—Ä—ã—Ç–æ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
          <div class="metric-value">${fmt(eff)}</div>
        </div>
        <div class="metric-item">
          <div class="metric-label">–î–æ–ª—è –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</div>
          <div class="metric-value">${rtkShare.toFixed(1)}%</div>
        </div>
      </div>
    </div>
    <div class="date-info">${new Date().toLocaleDateString('ru-RU')}</div>
    <div class="page-number">1</div>
  </div>

  <!-- –°–ª–∞–π–¥ 2: –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–≤—Å–µ–≥–æ) -->
  <div class="slide">
    <div class="slide-header">
      <h1>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º (–≤—Å–µ–≥–æ)</h1>
      <div class="subtitle">–í—Å–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã —Å–≤—è–∑–∏</div>
    </div>
    <div class="content-grid">
      <div class="chart-container">
        <img src="${chartMainImg}" alt="–ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏ –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º">
      </div>
      <div>
        <table>
          <thead>
            <tr>
              <th>–§–∏–ª–∏–∞–ª</th>
              <th>–ü—Ä–µ–¥.</th>
              <th>–¢–µ–∫.</th>
              <th>Œî</th>
            </tr>
          </thead>
          <tbody>
            ${sortedBranchRows.map(row => `
              <tr>
                <td style="font-weight: 600;">${row.b}</td>
                <td>${fmt(row.p)}</td>
                <td>${fmt(row.c)}</td>
                <td class="${row.d > 0 ? 'positive' : row.d < 0 ? 'negative' : 'neutral'}" style="font-weight: 700;">
                  ${row.d > 0 ? '+' : ''}${fmt(row.d)}
                </td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr>
              <td>–ò–¢–û–ì–û</td>
              <td>${fmt(sortedBranchRows.reduce((s, r) => s + r.p, 0))}</td>
              <td>${fmt(sortedBranchRows.reduce((s, r) => s + r.c, 0))}</td>
              <td>${fmt(sortedBranchRows.reduce((s, r) => s + r.d, 0))}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <div class="date-info">${new Date().toLocaleDateString('ru-RU')}</div>
    <div class="page-number">2</div>
  </div>

  <!-- –°–ª–∞–π–¥ 3: –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425 -->
  <div class="slide">
    <div class="slide-header">
      <h1>–í —Ç–æ–º —á–∏—Å–ª–µ –¥–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425</h1>
      <div class="subtitle">–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</div>
    </div>
    <div class="content-grid">
      <div class="chart-container">
        <img src="${chart425Img}" alt="–ì—Ä–∞—Ñ–∏–∫ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425">
      </div>
      <div>
        <table>
          <thead>
            <tr>
              <th>–§–∏–ª–∏–∞–ª</th>
              <th>–ü—Ä–µ–¥.</th>
              <th>–¢–µ–∫.</th>
              <th>Œî</th>
            </tr>
          </thead>
          <tbody>
            ${sortedBranchRowsS3.map(row => `
              <tr>
                <td style="font-weight: 600;">${row.b}</td>
                <td>${fmt(row.p)}</td>
                <td>${fmt(row.c)}</td>
                <td class="${row.d > 0 ? 'positive' : row.d < 0 ? 'negative' : 'neutral'}" style="font-weight: 700;">
                  ${row.d > 0 ? '+' : ''}${fmt(row.d)}
                </td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr>
              <td>–ò–¢–û–ì–û</td>
              <td>${fmt(sortedBranchRowsS3.reduce((s, r) => s + r.p, 0))}</td>
              <td>${fmt(sortedBranchRowsS3.reduce((s, r) => s + r.c, 0))}</td>
              <td>${fmt(sortedBranchRowsS3.reduce((s, r) => s + r.d, 0))}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <div class="date-info">${new Date().toLocaleDateString('ru-RU')}</div>
    <div class="page-number">3</div>
  </div>

  <!-- –°–ª–∞–π–¥ 4: –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª -->
  <div class="slide">
    <div class="slide-header">
      <h1>–í —Ç–æ–º —á–∏—Å–ª–µ –¥–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h1>
      <div class="subtitle">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ —Ñ–∏–ª–∏–∞–ª–∞–º</div>
    </div>
    <div class="content-grid">
      <div class="chart-container">
        <img src="${chartRTKImg}" alt="–ì—Ä–∞—Ñ–∏–∫ –ü–ê–û –†–æ—Å—Ç–µ–ª–µ–∫–æ–º">
      </div>
      <div>
        <table>
          <thead>
            <tr>
              <th>–§–∏–ª–∏–∞–ª</th>
              <th>–ü—Ä–µ–¥.</th>
              <th>–¢–µ–∫.</th>
              <th>Œî</th>
            </tr>
          </thead>
          <tbody>
            ${sortedBranchRowsS4.map(row => `
              <tr>
                <td style="font-weight: 600;">${row.b}</td>
                <td>${fmt(row.p)}</td>
                <td>${fmt(row.c)}</td>
                <td class="${row.d > 0 ? 'positive' : row.d < 0 ? 'negative' : 'neutral'}" style="font-weight: 700;">
                  ${row.d > 0 ? '+' : ''}${fmt(row.d)}
                </td>
              </tr>
            `).join('')}
          </tbody>
          <tfoot>
            <tr>
              <td>–ò–¢–û–ì–û</td>
              <td>${fmt(sortedBranchRowsS4.reduce((s, r) => s + r.p, 0))}</td>
              <td>${fmt(sortedBranchRowsS4.reduce((s, r) => s + r.c, 0))}</td>
              <td>${fmt(sortedBranchRowsS4.reduce((s, r) => s + r.d, 0))}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <div class="date-info">${new Date().toLocaleDateString('ru-RU')}</div>
    <div class="page-number">4</div>
  </div>

  <!-- –°–ª–∞–π–¥ 5: –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –≤ —Ä–∞–∑—Ä–µ–∑–µ —Ñ–∏–ª–∏–∞–ª–æ–≤ -->
  <div class="slide">
    <div class="slide-header">
      <h1>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –≤ —Ä–∞–∑—Ä–µ–∑–µ —Ñ–∏–ª–∏–∞–ª–æ–≤</h1>
      <div class="subtitle">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞ –Ω–µ–¥–µ–ª—é</div>
    </div>
    <table class="status-matrix">
      <thead>
        <tr>
          <th style="text-align: left;">–§–∏–ª–∏–∞–ª</th>
          ${STATUS_PATTERNS.map(sp => `<th>${sp.short}</th>`).join('')}
          <th>–ò—Ç–æ–≥–æ</th>
        </tr>
      </thead>
      <tbody>
        ${sortedStatusRows.map(row => {
          const rowTotal = STATUS_PATTERNS.reduce((sum, sp) => 
            sum + (row.statuses[sp.key]?.d || 0), 0
          );
          return `
            <tr>
              <td style="font-weight: 600; text-align: left;">${row.b}</td>
              ${STATUS_PATTERNS.map(sp => {
                const d = row.statuses[sp.key]?.d || 0;
                return `<td class="${d > 0 ? 'positive' : d < 0 ? 'negative' : 'neutral'}" style="font-weight: 600;">
                  ${d !== 0 ? (d > 0 ? '+' : '') + fmt(d) : '‚Äî'}
                </td>`;
              }).join('')}
              <td style="font-weight: 700;" class="${rowTotal > 0 ? 'positive' : rowTotal < 0 ? 'negative' : 'neutral'}">
                ${rowTotal !== 0 ? (rowTotal > 0 ? '+' : '') + fmt(rowTotal) : '‚Äî'}
              </td>
            </tr>
          `;
        }).join('')}
      </tbody>
      <tfoot>
        <tr>
          <td style="text-align: left;">–ò–¢–û–ì–û</td>
          ${STATUS_PATTERNS.map(sp => {
            const total = sortedStatusRows.reduce((sum, row) => 
              sum + (row.statuses[sp.key]?.d || 0), 0
            );
            return `<td>${total !== 0 ? (total > 0 ? '+' : '') + fmt(total) : '‚Äî'}</td>`;
          }).join('')}
          <td>
            ${fmt(sortedStatusRows.reduce((sum, row) => 
              sum + STATUS_PATTERNS.reduce((s, sp) => s + (row.statuses[sp.key]?.d || 0), 0), 0))}
          </td>
        </tr>
      </tfoot>
    </table>
    <div class="date-info">${new Date().toLocaleDateString('ru-RU')}</div>
    <div class="page-number">5</div>
  </div>

  <!-- –°–ª–∞–π–¥ 6: –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –≤—Å–µ–≥–æ –ø–æ –æ–±—â–µ—Å—Ç–≤—É -->
  <div class="slide">
    <div class="slide-header">
      <h1>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –≤—Å–µ–≥–æ –ø–æ –æ–±—â–µ—Å—Ç–≤—É</h1>
      <div class="subtitle">–°–≤–æ–¥–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞ –Ω–µ–¥–µ–ª—é</div>
    </div>
    <div class="content-grid">
      <div class="chart-container">
        <img src="${statusTotalImg}" alt="–ì—Ä–∞—Ñ–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º">
      </div>
      <div>
        <table>
          <thead>
            <tr>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–ü—Ä–µ–¥.</th>
              <th>–¢–µ–∫.</th>
              <th>Œî</th>
            </tr>
          </thead>
          <tbody>
            ${STATUS_PATTERNS.map(sp => {
              const prevTotal = sortedStatusRows.reduce((sum, row) => 
                sum + (row.statuses[sp.key]?.p || 0), 0
              );
              const currTotal = sortedStatusRows.reduce((sum, row) => 
                sum + (row.statuses[sp.key]?.c || 0), 0
              );
              const delta = sortedStatusRows.reduce((sum, row) => 
                sum + (row.statuses[sp.key]?.d || 0), 0
              );
              return `
                <tr>
                  <td style="font-weight: 600;">${sp.title}</td>
                  <td>${fmt(prevTotal)}</td>
                  <td>${fmt(currTotal)}</td>
                  <td class="${delta > 0 ? 'positive' : delta < 0 ? 'negative' : 'neutral'}" style="font-weight: 700;">
                    ${delta > 0 ? '+' : ''}${fmt(delta)}
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
          <tfoot>
            <tr>
              <td>–ò–¢–û–ì–û</td>
              <td>${fmt(STATUS_PATTERNS.reduce((sum, sp) => 
                sum + sortedStatusRows.reduce((s, row) => 
                  s + (row.statuses[sp.key]?.p || 0), 0), 0))}</td>
              <td>${fmt(STATUS_PATTERNS.reduce((sum, sp) => 
                sum + sortedStatusRows.reduce((s, row) => 
                  s + (row.statuses[sp.key]?.c || 0), 0), 0))}</td>
              <td>${fmt(STATUS_PATTERNS.reduce((sum, sp) => 
                sum + sortedStatusRows.reduce((s, row) => 
                  s + (row.statuses[sp.key]?.d || 0), 0), 0))}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <div class="date-info">${new Date().toLocaleDateString('ru-RU')}</div>
    <div class="page-number">6</div>
  </div>
</body>
</html>`;
    }

    function generateDetailedReport(curr, prev, dyn, planFactHTML) {
      return `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç –í–û–õ–°</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f8fafc;
      color: #1e293b;
    }
    h1 { color: #1e40af; margin-bottom: 10px; }
    h2 { color: #1e40af; margin-top: 30px; margin-bottom: 15px; }
    .info { background: #eff6ff; padding: 20px; border-radius: 8px; margin: 20px 0; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; background: white; }
    th, td { padding: 10px; border: 1px solid #e2e8f0; font-size: 0.875rem; }
    th { background: #1e40af; color: white; }
    tr:nth-child(even) { background: #f8fafc; }
    @media (max-width: 768px) {
      body { padding: 10px; }
      table { font-size: 0.75rem; }
      th, td { padding: 6px; }
    }
  </style>
</head>
<body>
  <h1>–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç –ø–æ –í–û–õ–°</h1>
  <div class="info">
    <strong>–ü–µ—Ä–∏–æ–¥:</strong> ${prev.date} ‚Äî ${curr.date}<br>
    <strong>–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω:</strong> ${new Date().toLocaleDateString('ru-RU')}
  </div>
  
  <h2>–ü–ª–∞–Ω-–§–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ë–ü</h2>
  ${planFactHTML}
  
  <h2>–ö–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
  <table>
    <tr>
      <th>–ü–æ–∫–∞–∑–∞—Ç–µ–ª—å</th>
      <th>–ü—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ–¥–µ–ª—è</th>
      <th>–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</th>
      <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
    </tr>
    <tr>
      <td>–í —Ä–∞–±–æ—Ç–µ –≤—Å–µ–≥–æ</td>
      <td>${fmt(prev.p1.totals.in_work_total)}</td>
      <td>${fmt(curr.p1.totals.in_work_total)}</td>
      <td>${fmt(dyn.in_work_total)}</td>
    </tr>
    <tr>
      <td>–£–∑–∞–∫–æ–Ω–µ–Ω–æ</td>
      <td>${fmt(prev.p1.totals.legalized)}</td>
      <td>${fmt(curr.p1.totals.legalized)}</td>
      <td>${fmt(dyn.legalized)}</td>
    </tr>
    <tr>
      <td>–î–µ–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ</td>
      <td>${fmt(prev.p1.totals.dismantled_ytd)}</td>
      <td>${fmt(curr.p1.totals.dismantled_ytd)}</td>
      <td>${fmt(dyn.dismantled_ytd)}</td>
    </tr>
    <tr>
      <td>–ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</td>
      <td>${fmt(prev.p1.totals.rtk_in_work)}</td>
      <td>${fmt(curr.p1.totals.rtk_in_work)}</td>
      <td>${fmt(dyn.rtk_in_work)}</td>
    </tr>
  </table>
  
  <h2>–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –≤—Å–µ–º —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
  <table>
    <thead>
      <tr>
        <th>–§–∏–ª–∏–∞–ª</th>
        <th>–ü—Ä–µ–¥—ã–¥—É—â–∞—è</th>
        <th>–¢–µ–∫—É—â–∞—è</th>
        <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
      </tr>
    </thead>
    <tbody>
      ${dyn.branchRows.map(row => `
        <tr>
          <td>${row.b}</td>
          <td>${fmt(row.p)}</td>
          <td>${fmt(row.c)}</td>
          <td>${fmt(row.d)}</td>
        </tr>
      `).join('')}
    </tbody>
    <tfoot>
      <tr style="font-weight: 700;">
        <td>–ò–¢–û–ì–û</td>
        <td>${fmt(dyn.branchRows.reduce((s, r) => s + r.p, 0))}</td>
        <td>${fmt(dyn.branchRows.reduce((s, r) => s + r.c, 0))}</td>
        <td>${fmt(dyn.branchRows.reduce((s, r) => s + r.d, 0))}</td>
      </tr>
    </tfoot>
  </table>

  <h2>–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –≤ —Ä–∞–∑—Ä–µ–∑–µ —Ñ–∏–ª–∏–∞–ª–æ–≤</h2>
  <table>
    <thead>
      <tr>
        <th>–§–∏–ª–∏–∞–ª</th>
        ${STATUS_PATTERNS.map(sp => `<th>${sp.short}</th>`).join('')}
      </tr>
    </thead>
    <tbody>
      ${dyn.statusRows.map(row => `
        <tr>
          <td>${row.b}</td>
          ${STATUS_PATTERNS.map(sp => {
            const d = row.statuses[sp.key]?.d || 0;
            return `<td>${d > 0 ? '+' : ''}${fmt(d)}</td>`;
          }).join('')}
        </tr>
      `).join('')}
    </tbody>
  </table>
</body>
</html>`;
    }

    function generateDashboardHTML(curr, prev, dyn, planFactHTML) {
      // –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      return document.documentElement.outerHTML;
    }

    function generateWordReport(curr, prev, dyn, planFactHTML) {
      return `<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>–û—Ç—á–µ—Ç –í–û–õ–° –¥–ª—è Word</title>
  <style>
    @page { size: A4; margin: 2cm; }
    body { font-family: 'Times New Roman', serif; font-size: 12pt; line-height: 1.5; }
    h1 { font-size: 16pt; margin-bottom: 12pt; }
    h2 { font-size: 14pt; margin-top: 12pt; margin-bottom: 6pt; }
    table { width: 100%; border-collapse: collapse; margin: 12pt 0; }
    th, td { border: 1px solid black; padding: 6pt; }
    th { background: #f0f0f0; font-weight: bold; }
  </style>
</head>
<body>
  <h1>–ê–û ¬´–†–æ—Å—Å–µ—Ç–∏ –ö—É–±–∞–Ω—å¬ª</h1>
  <h2>–û—Ç—á–µ—Ç –æ –¥–∏–Ω–∞–º–∏–∫–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –í–û–õ–°</h2>
  <p><strong>–ü–µ—Ä–∏–æ–¥:</strong> ${prev.date} ‚Äî ${curr.date}</p>
  
  <h2>–ü–ª–∞–Ω-–§–∞–∫—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –ë–ü</h2>
  ${planFactHTML}
  
  <h2>1. –û–±—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h2>
  <p>–ó–∞ –æ—Ç—á–µ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –≤—ã—è–≤–ª–µ–Ω–æ ${fmt(dyn.found_week)} –Ω–æ–≤—ã—Ö —Å–ª—É—á–∞–µ–≤ –±–µ–∑–¥–æ–≥–æ–≤–æ—Ä–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –í–û–õ–°.</p>
  <p>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—ä–µ–∫—Ç–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç ${fmt(curr.p1.totals.in_work_total)} —à—Ç.</p>
  
  <h2>2. –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –≤—Å–µ–º —Ñ–∏–ª–∏–∞–ª–∞–º</h2>
  <table>
    <thead>
      <tr>
        <th>‚Ññ</th>
        <th>–§–∏–ª–∏–∞–ª</th>
        <th>–ù–∞ –Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞</th>
        <th>–ù–∞ –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞</th>
        <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
      </tr>
    </thead>
    <tbody>
      ${dyn.branchRows.map((row, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${row.b}</td>
          <td>${fmt(row.p)}</td>
          <td>${fmt(row.c)}</td>
          <td>${fmt(row.d)}</td>
        </tr>
      `).join('')}
    </tbody>
    <tfoot>
      <tr>
        <th></th>
        <th>–ò–¢–û–ì–û</th>
        <th>${fmt(dyn.branchRows.reduce((s, r) => s + r.p, 0))}</th>
        <th>${fmt(dyn.branchRows.reduce((s, r) => s + r.c, 0))}</th>
        <th>${fmt(dyn.branchRows.reduce((s, r) => s + r.d, 0))}</th>
      </tr>
    </tfoot>
  </table>

  <h2>3. –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü—Ä–∏–∫–∞–∑—É ‚Ññ425</h2>
  <table>
    <thead>
      <tr>
        <th>‚Ññ</th>
        <th>–§–∏–ª–∏–∞–ª</th>
        <th>–ù–∞ –Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞</th>
        <th>–ù–∞ –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞</th>
        <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
      </tr>
    </thead>
    <tbody>
      ${dyn.branchRowsS3.map((row, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${row.b}</td>
          <td>${fmt(row.p)}</td>
          <td>${fmt(row.c)}</td>
          <td>${fmt(row.d)}</td>
        </tr>
      `).join('')}
    </tbody>
    <tfoot>
      <tr>
        <th></th>
        <th>–ò–¢–û–ì–û</th>
        <th>${fmt(dyn.branchRowsS3.reduce((s, r) => s + r.p, 0))}</th>
        <th>${fmt(dyn.branchRowsS3.reduce((s, r) => s + r.c, 0))}</th>
        <th>${fmt(dyn.branchRowsS3.reduce((s, r) => s + r.d, 0))}</th>
      </tr>
    </tfoot>
  </table>

  <h2>4. –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ü–ê–û ¬´–†–æ—Å—Ç–µ–ª–µ–∫–æ–º¬ª</h2>
  <table>
    <thead>
      <tr>
        <th>‚Ññ</th>
        <th>–§–∏–ª–∏–∞–ª</th>
        <th>–ù–∞ –Ω–∞—á–∞–ª–æ –ø–µ—Ä–∏–æ–¥–∞</th>
        <th>–ù–∞ –∫–æ–Ω–µ—Ü –ø–µ—Ä–∏–æ–¥–∞</th>
        <th>–ò–∑–º–µ–Ω–µ–Ω–∏–µ</th>
      </tr>
    </thead>
    <tbody>
      ${dyn.branchRowsS4.map((row, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${row.b}</td>
          <td>${fmt(row.p)}</td>
          <td>${fmt(row.c)}</td>
          <td>${fmt(row.d)}</td>
        </tr>
      `).join('')}
    </tbody>
    <tfoot>
      <tr>
        <th></th>
        <th>–ò–¢–û–ì–û</th>
        <th>${fmt(dyn.branchRowsS4.reduce((s, r) => s + r.p, 0))}</th>
        <th>${fmt(dyn.branchRowsS4.reduce((s, r) => s + r.c, 0))}</th>
        <th>${fmt(dyn.branchRowsS4.reduce((s, r) => s + r.d, 0))}</th>
      </tr>
    </tfoot>
  </table>

  <h2>5. –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º —Ä–∞–±–æ—Ç</h2>
  <table>
    <thead>
      <tr>
        <th>–§–∏–ª–∏–∞–ª</th>
        ${STATUS_PATTERNS.map(sp => `<th>${sp.title}</th>`).join('')}
      </tr>
    </thead>
    <tbody>
      ${dyn.statusRows.map(row => `
        <tr>
          <td>${row.b}</td>
          ${STATUS_PATTERNS.map(sp => {
            const d = row.statuses[sp.key]?.d || 0;
            return `<td>${d > 0 ? '+' : ''}${fmt(d)}</td>`;
          }).join('')}
        </tr>
      `).join('')}
    </tbody>
  </table>
  
  <p style="margin-top: 24pt;">
    <strong>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å:</strong> _______________________<br>
    <strong>–î–∞—Ç–∞:</strong> ${new Date().toLocaleDateString('ru-RU')}
  </p>
</body>
</html>`;
    }

    // ==================== –£—Ç–∏–ª–∏—Ç—ã ====================
    function showMessage(text, type = 'info') {
      const statusEl = document.getElementById('uploadStatus');
      
      if (type === 'loading') {
        statusEl.innerHTML = `<div class="loader"><div class="spinner"></div><span>${text}</span></div>`;
      } else {
        const alertClass = type === 'error' ? 'alert-error' : type === 'success' ? 'alert-success' : 'alert-info';
        statusEl.innerHTML = `<div class="alert ${alertClass}">
          <span>${type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è'}</span>
          <span>${text}</span>
        </div>`;
        
        if (type !== 'error') {
          setTimeout(() => {
            statusEl.innerHTML = '';
          }, 3000);
        }
      }
    }

    function downloadHTML(content, filename) {
      const blob = new Blob([content], { type: 'text/html;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ====================
    document.addEventListener('DOMContentLoaded', () => {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–∞–Ω-—Ñ–∞–∫—Ç –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
      loadPlanFact();
      showMessage('–ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF-—Ñ–∞–π–ª—ã –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã', 'info');
    });
  </script>
</body>
</html>
